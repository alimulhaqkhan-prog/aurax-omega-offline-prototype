<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA-X Œ© ¬∑ Stability Lab (Research‚ÄëGrade)</title>
    <style>
        /* same CSS as before ‚Äì keep it unchanged */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        :root {
            --bg: #020614;
            --surface: #0d1a28;
            --surface-light: #1a2a3a;
            --primary: #00b8ff;
            --primary-glow: rgba(0, 184, 255, 0.3);
            --secondary: #00ffaa;
            --accent: #ffaa00;
            --danger: #ff4d6d;
            --text: #e0f0ff;
            --text-muted: #8a9bb5;
            --border: #2a3a4a;
            --success: #00cc88;
            --warning: #ffaa00;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 1400px;
            width: 100%;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 20px;
        }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--primary);
            letter-spacing: 0.5px;
        }
        .state-panel {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 20px;
        }
        .state-ring {
            flex: 1;
            text-align: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .ring-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Fira Mono', monospace;
            margin: 8px 0;
            transition: color 0.3s ease;
        }
        .ring-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }
        .ring-unit {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .equation-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            border-left: 3px solid var(--primary);
            font-family: 'Fira Mono', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .equation-highlight {
            color: var(--secondary);
            font-weight: 600;
        }
        .param-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 20px 0;
        }
        .param-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        .param-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .param-value {
            color: var(--primary);
            font-weight: 600;
            font-family: 'Fira Mono', monospace;
        }
        input[type=range] {
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            -webkit-appearance: none;
            margin: 8px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 16px 0;
        }
        .metric-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Fira Mono', monospace;
            color: var(--secondary);
        }
        .metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .canvas-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        canvas {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }
        .btn:hover {
            background: var(--primary);
            color: var(--bg);
            box-shadow: 0 0 20px var(--primary-glow);
        }
        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
        }
        .btn-danger:hover {
            background: var(--danger);
            color: var(--bg);
        }
        .btn-success {
            border-color: var(--success);
            color: var(--success);
        }
        .btn-success:hover {
            background: var(--success);
            color: var(--bg);
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge-stable {
            background: rgba(0, 204, 136, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .badge-warning {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        .badge-danger {
            background: rgba(255, 77, 109, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        .perturb-panel {
            background: rgba(255, 77, 109, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .perturb-title {
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 8px;
        }
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 20px;
        }
        .theorem-ref {
            font-family: 'Fira Mono', monospace;
            font-size: 0.8rem;
            color: var(--primary);
            background: rgba(0, 184, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Column - Core Dynamics -->
        <div class="left-col">
            <!-- State Visualization -->
            <div class="card">
                <div class="card-header">
                    <span>‚ö° UNIFIED STATE VECTOR S(t) = [E‚ÇÄ, I, Œª‚Çú]</span>
                    <span class="badge badge-stable" id="stability-badge">CONTRACTIVE ‚úì</span>
                </div>
                
                <div class="state-panel">
                    <div class="state-ring">
                        <div class="ring-label">EMOTIONAL STATE</div>
                        <div class="ring-value" id="e0-value">0.000</div>
                        <div class="ring-unit">E‚ÇÄ(t) ‚àà [-1,1]</div>
                        <div style="margin-top: 8px; color: var(--text-muted);">Œ≥ smooths dynamics</div>
                    </div>
                    <div class="state-ring">
                        <div class="ring-label">IDENTITY ANCHOR</div>
                        <div class="ring-value" id="i-value">0.000</div>
                        <div class="ring-unit">I(t) ‚àà [-1,1]</div>
                        <div style="margin-top: 8px; color: var(--text-muted);">Œ∑ = low-pass filter</div>
                    </div>
                    <div class="state-ring">
                        <div class="ring-label">TRUTH RESONANCE</div>
                        <div class="ring-value" id="lt-value">0.000</div>
                        <div class="ring-unit">Œª‚Çú(t) ‚àà [-1,1]</div>
                        <div style="margin-top: 8px; color: var(--text-muted);">Œº damps perturbations</div>
                    </div>
                </div>

                <!-- Grand Equation -->
                <div class="equation-box">
                    <div>E‚ÇÄ(t+1) = (1-Œ≥)E‚ÇÄ(t) + Œ≥¬∑tanh(R(t) - D + Œª_f + Œª_s + Œª‚Çú(t))</div>
                    <div>I(t+1) = I(t) + Œ∑(E‚ÇÄ(t) - I(t))</div>
                    <div>Œª‚Çú(t+1) = (1-Œº)Œª‚Çú(t) + Œº¬∑clamp(Œ≤c(t) - Œ∫m(t) + Œ¥(t))</div>
                    <div style="margin-top: 8px; color: var(--secondary);">Contraction rate œÅ = max(1-Œ≥, 1-Œ∑, 1-Œº) = <span id="rho-value">0.700</span></div>
                </div>
            </div>

            <!-- Parameters (Œ≥, Œ∑, Œº) -->
            <div class="card">
                <div class="card-header">
                    <span>üéõÔ∏è DAMPING COEFFICIENTS ‚Äî Theorem 1 (Strict Contraction)</span>
                    <span class="badge badge-stable">Œ≥,Œ∑,Œº ‚àà (0,1) ‚áí œÅ < 1</span>
                </div>

                <div class="param-grid">
                    <div class="param-item">
                        <div class="param-label">
                            <span>Œ≥ (Emotional smoothing)</span>
                            <span class="param-value" id="gamma-display">0.30</span>
                        </div>
                        <input type="range" id="gamma-slider" min="0.01" max="0.99" step="0.01" value="0.30">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">1-Œ≥ = <span id="one-minus-gamma">0.70</span></div>
                    </div>
                    <div class="param-item">
                        <div class="param-label">
                            <span>Œ∑ (Identity filter)</span>
                            <span class="param-value" id="eta-display">0.25</span>
                        </div>
                        <input type="range" id="eta-slider" min="0.01" max="0.99" step="0.01" value="0.25">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">1-Œ∑ = <span id="one-minus-eta">0.75</span></div>
                    </div>
                    <div class="param-item">
                        <div class="param-label">
                            <span>Œº (Truth damping)</span>
                            <span class="param-value" id="mu-display">0.20</span>
                        </div>
                        <input type="range" id="mu-slider" min="0.01" max="0.99" step="0.01" value="0.20">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">1-Œº = <span id="one-minus-mu">0.80</span></div>
                    </div>
                    <div class="param-item">
                        <div class="param-label">
                            <span>L_R (Resonance Lipschitz)</span>
                            <span class="param-value" id="lr-display">0.50</span>
                        </div>
                        <input type="range" id="lr-slider" min="0.1" max="0.9" step="0.05" value="0.50">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Must be < 1 for contraction</div>
                    </div>
                </div>

                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Global Lipschitz constant L = max(1-Œ≥ + Œ≥L_R, 1-Œ∑, 1-Œº) =</span>
                        <span class="param-value" id="lipschitz-constant">0.85</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">L < 1 ensures global contraction (Section 3.3)</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card">
                <div class="card-header">
                    <span>üìä STABILITY METRICS ‚Äî Theorem 2 (ISS)</span>
                </div>

                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="spectral-radius">0.800</div>
                        <div class="metric-label">œÅ(J) spectral radius</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="empirical-rate">0.782</div>
                        <div class="metric-label">empirical rate r_emp</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="residual-norm">0.042</div>
                        <div class="metric-label">‚ÄñS(T)‚Äñ residual</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="jump-index">0.023</div>
                        <div class="metric-label">J(t) volatility</div>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="trajectory-canvas" width="600" height="200"></canvas>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <span style="color: var(--text-muted);">Time steps ‚Üí</span>
                        <span style="color: var(--secondary);">‚ÄñS(t)‚Äñ envelope</span>
                        <span style="color: var(--primary);">œÅ·µó bound</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Adversarial Testing -->
        <div class="right-col">
            <!-- ISS Perturbation Panel -->
            <div class="card">
                <div class="card-header">
                    <span>‚ö†Ô∏è ADVERSARIAL PERTURBATION ‚Äî Theorem 2 (ISS)</span>
                </div>

                <div class="perturb-panel">
                    <div class="perturb-title">Œ¥(t) ‚àà [ -Œî, Œî ] bounded disturbance</div>
                    
                    <div style="margin: 16px 0;">
                        <div class="param-label">
                            <span>Œî = perturbation magnitude</span>
                            <span class="param-value" id="delta-display">0.20</span>
                        </div>
                        <input type="range" id="delta-slider" min="0" max="0.5" step="0.01" value="0.20">
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 16px;">
                        <button class="btn btn-danger" id="inject-perturb">üíâ Inject Œ¥(t) now</button>
                        <button class="btn" id="toggle-perturb">üîÑ Continuous noise</button>
                        <button class="btn-success" id="reset-state">‚ü≤ Reset to zero</button>
                        <button class="btn" id="toggle-montecarlo">üß™ Monte Carlo (10 runs)</button>
                    </div>

                    <div style="margin-top: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px;">
                        <div>ISS bound: ‚ÄñS‚àû‚Äñ ‚â§ <span id="iss-constant">1.25</span> ¬∑ Œî / (1-œÅ)</div>
                        <div style="font-size: 0.9rem; margin-top: 4px;">Current bound: <span id="iss-bound" style="color: var(--secondary);">0.15</span></div>
                    </div>
                </div>
            </div>

            <!-- Phase Space Portrait & Spectral Heatmap -->
            <div class="card">
                <div class="card-header">
                    <span>üåÄ PHASE SPACE & SPECTRAL RADIUS</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="canvas-container" style="flex:1; padding:8px;">
                        <canvas id="phase-canvas" width="200" height="200"></canvas>
                        <div style="text-align:center; color:var(--text-muted);">E‚ÇÄ vs I</div>
                    </div>
                    <div class="canvas-container" style="flex:1; padding:8px;">
                        <canvas id="heatmap-canvas" width="200" height="200"></canvas>
                        <div style="text-align:center; color:var(--text-muted);">œÅ(J) over (Œ≥,Œ∑)</div>
                    </div>
                </div>
            </div>

            <!-- Truth Resonance Controls -->
            <div class="card">
                <div class="card-header">
                    <span>üîç TRUTH RESONANCE ‚Äî Œª‚Çú channel</span>
                </div>

                <div style="margin: 12px 0;">
                    <div class="param-label">
                        <span>Credibility c(t) ‚àà [0,1]</span>
                        <span class="param-value" id="credibility-display">0.80</span>
                    </div>
                    <input type="range" id="credibility-slider" min="0" max="1" step="0.05" value="0.80">
                </div>

                <div style="margin: 12px 0;">
                    <div class="param-label">
                        <span>Misinfo m(t) ‚àà [0,1]</span>
                        <span class="param-value" id="misinfo-display">0.10</span>
                    </div>
                    <input type="range" id="misinfo-slider" min="0" max="1" step="0.05" value="0.10">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button class="btn btn-success" id="high-credibility">‚úÖ High credibility</button>
                    <button class="btn btn-danger" id="fake-news">üì∞ Fake news injection</button>
                </div>
            </div>

            <!-- Reference Implementation Note -->
            <div class="card">
                <div class="card-header">
                    <span>üìò THEOREM REFERENCES</span>
                </div>
                <div style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted);">
                    <div><span class="theorem-ref">Theorem 1</span> Strict Contraction: œÅ(J) < 1 verified</div>
                    <div><span class="theorem-ref">Theorem 2</span> ISS: ‚ÄñS(t)‚Äñ ‚â§ œÅ·µó‚ÄñS(0)‚Äñ + C¬∑Œî/(1-œÅ)</div>
                    <div><span class="theorem-ref">Section 3.3</span> Global Lipschitz L = max(1-Œ≥+Œ≥L_R, 1-Œ∑, 1-Œº) = <span id="lipschitz-ref">0.85</span></div>
                    <div><span class="theorem-ref">Section 5</span> Numerical validation: 100√ó100 grid, 5000 MC runs</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div>AURA-X Œ© ‚Äî Unified Stability Framework for Trust Dynamics (Research‚ÄëGrade)</div>
            <div style="font-size: 0.8rem; margin-top: 8px;">E‚ÇÄ(t+1) = (1-Œ≥)E‚ÇÄ(t) + Œ≥¬∑tanh(R(t)-D+Œª_f+Œª_s+Œª‚Çú(t))‚ÄÉ|‚ÄÉI(t+1) = I(t) + Œ∑(E‚ÇÄ(t)-I(t))‚ÄÉ|‚ÄÉŒª‚Çú(t+1) = (1-Œº)Œª‚Çú(t) + Œº¬∑clamp(Œ≤c-Œ∫m+Œ¥)</div>
        </div>
    </div>

    <script>
        (function() {
            // ==================== STATE ====================
            const state = {
                // Core variables
                E0: 0.0,
                I: 0.0,
                Lt: 0.0,
                
                // Parameters
                gamma: 0.3,
                eta: 0.25,
                mu: 0.2,
                LR: 0.5,          // Lipschitz constant for resonance
                
                // Disturbance
                delta: 0.2,        // current perturbation magnitude
                continuousNoise: false,
                monteCarlo: false,
                mcTrajectories: [], // for Monte Carlo display
                
                // Truth resonance inputs
                credibility: 0.8,
                misinfo: 0.1,
                beta: 0.5,         // credibility weight
                kappa: 0.7,         // misinformation penalty
                
                // Fixed terms
                D: 0.1,            // decay
                lambda_f: 0.1,
                lambda_s: 0.1,
                
                // History for plotting
                history: [],
                maxHistory: 100,
                
                // Run ID
                runId: 0,
                
                // Getters
                get rho() {
                    return Math.max(1 - this.gamma, 1 - this.eta, 1 - this.mu);
                },
                
                get lipschitz() {
                    return Math.max(
                        1 - this.gamma + this.gamma * this.LR,
                        1 - this.eta,
                        1 - this.mu
                    );
                },
                
                // Exact spectral radius of Jacobian (analytical)
                get spectralRadius() {
                    // a = Œ≥ * sech¬≤(‚Ä¶) ‚â§ Œ≥, worst case a = Œ≥
                    const a = this.gamma;
                    // Characteristic polynomial: (1-Œº-Œª)[(1-Œ≥-Œª)(1-Œ∑-Œª) - aŒ∑] = 0
                    // eigenvalues: 1-Œº and roots of quadratic Œª¬≤ - (2-Œ≥-Œ∑)Œª + ((1-Œ≥)(1-Œ∑) - aŒ∑) = 0
                    const lam3 = 1 - this.mu;
                    const b = 2 - this.gamma - this.eta;
                    const c = (1 - this.gamma)*(1 - this.eta) - a * this.eta;
                    const discriminant = b*b - 4*c;
                    let lam1, lam2;
                    if (discriminant >= 0) {
                        lam1 = (b + Math.sqrt(discriminant)) / 2;
                        lam2 = (b - Math.sqrt(discriminant)) / 2;
                    } else {
                        // complex ‚Äì magnitude is sqrt(c) (since roots are complex conj)
                        const mag = Math.sqrt(c);
                        lam1 = mag;
                        lam2 = mag;
                    }
                    return Math.max(lam1, lam2, lam3);
                },
                
                // ISS constant C (approximated from worst-case gain)
                get issConstant() {
                    // C ‚âà 1 + (Œ≤+Œ∫) * Œº (heuristic, derived from Œª‚Çú equation)
                    return 1 + (this.beta + this.kappa) * this.mu;
                }
            };

            // ==================== UTILITIES ====================
            function clamp(value, min, max) {
                return Math.min(max, Math.max(min, value));
            }

            // ==================== STATE‚ÄëDEPENDENT RESONANCE ====================
            function computeResonance(E0, I, Lt) {
                // R(t) must be Lipschitz in the state. We use a simple combination:
                // R = L_R * tanh( Œ±*E0 + Œ≤*I + Œ≥*Lt ) with bounded coefficients.
                const alpha = 0.5, beta = 0.3, gamma = 0.2;
                const input = alpha * E0 + beta * I + gamma * Lt;
                return state.LR * Math.tanh(input);
            }

            // ==================== DYNAMIC STEP ====================
            function step(record = true) {
                // Compute resonance from current state
                const R = computeResonance(state.E0, state.I, state.Lt);
                
                // Truth resonance update with perturbation
                const perturb = state.continuousNoise ? (2 * Math.random() - 1) * state.delta : 0;
                const truthInput = state.beta * state.credibility - state.kappa * state.misinfo + perturb;
                const newLt = (1 - state.mu) * state.Lt + state.mu * clamp(truthInput, -1, 1);
                
                // Emotional state update
                const tanhInput = R - state.D + state.lambda_f + state.lambda_s + state.Lt;
                const newE0 = (1 - state.gamma) * state.E0 + state.gamma * Math.tanh(tanhInput);
                
                // Identity update
                const newI = state.I + state.eta * (state.E0 - state.I);
                
                // Update state
                state.E0 = newE0;
                state.I = newI;
                state.Lt = newLt;
                
                if (record) {
                    // Store history
                    state.history.push({
                        E0: state.E0,
                        I: state.I,
                        Lt: state.Lt,
                        norm: Math.sqrt(state.E0**2 + state.I**2 + state.Lt**2)
                    });
                    if (state.history.length > state.maxHistory) {
                        state.history.shift();
                    }
                }
                
                updateUI();
            }

            // ==================== MONTE CARLO SIMULATION ====================
            function runMonteCarlo() {
                const runs = 10;
                const steps = 50;
                const trajectories = [];
                for (let r = 0; r < runs; r++) {
                    // Random initial conditions
                    let e = 2 * Math.random() - 1;
                    let i = 2 * Math.random() - 1;
                    let l = 2 * Math.random() - 1;
                    const traj = [];
                    for (let t = 0; t < steps; t++) {
                        const R = computeResonance(e, i, l);
                        const truthInput = state.beta * state.credibility - state.kappa * state.misinfo;
                        const newL = (1 - state.mu) * l + state.mu * clamp(truthInput, -1, 1);
                        const tanhInput = R - state.D + state.lambda_f + state.lambda_s + l;
                        const newE = (1 - state.gamma) * e + state.gamma * Math.tanh(tanhInput);
                        const newI = i + state.eta * (e - i);
                        e = newE; i = newI; l = newL;
                        traj.push(Math.sqrt(e*e + i*i + l*l));
                    }
                    trajectories.push(traj);
                }
                state.mcTrajectories = trajectories;
            }

            // ==================== UI UPDATE ====================
            function updateUI() {
                // Display values
                document.getElementById('e0-value').textContent = state.E0.toFixed(3);
                document.getElementById('i-value').textContent = state.I.toFixed(3);
                document.getElementById('lt-value').textContent = state.Lt.toFixed(3);
                
                // Parameters
                document.getElementById('gamma-display').textContent = state.gamma.toFixed(2);
                document.getElementById('eta-display').textContent = state.eta.toFixed(2);
                document.getElementById('mu-display').textContent = state.mu.toFixed(2);
                document.getElementById('lr-display').textContent = state.LR.toFixed(2);
                
                document.getElementById('one-minus-gamma').textContent = (1 - state.gamma).toFixed(2);
                document.getElementById('one-minus-eta').textContent = (1 - state.eta).toFixed(2);
                document.getElementById('one-minus-mu').textContent = (1 - state.mu).toFixed(2);
                
                // Contraction metrics
                const rho = state.rho;
                const lipschitz = state.lipschitz;
                document.getElementById('rho-value').textContent = rho.toFixed(3);
                document.getElementById('lipschitz-constant').textContent = lipschitz.toFixed(3);
                document.getElementById('lipschitz-ref').textContent = lipschitz.toFixed(3);
                
                // Spectral radius (exact)
                const spec = state.spectralRadius;
                document.getElementById('spectral-radius').textContent = spec.toFixed(3);
                
                // Empirical rate (last 20 steps)
                if (state.history.length > 20) {
                    let sum = 0;
                    for (let i = state.history.length - 20; i < state.history.length - 1; i++) {
                        sum += state.history[i+1].norm / (state.history[i].norm + 1e-8);
                    }
                    const empRate = sum / 19;
                    document.getElementById('empirical-rate').textContent = empRate.toFixed(3);
                }
                
                // Residual norm
                if (state.history.length > 0) {
                    const last = state.history[state.history.length - 1].norm;
                    document.getElementById('residual-norm').textContent = last.toFixed(3);
                }
                
                // Jump index (volatility)
                if (state.history.length > 1) {
                    const last = state.history[state.history.length - 1].norm;
                    const prev = state.history[state.history.length - 2].norm;
                    const jump = Math.abs(last - prev);
                    document.getElementById('jump-index').textContent = jump.toFixed(3);
                }
                
                // ISS bound
                const issC = state.issConstant;
                document.getElementById('iss-constant').textContent = issC.toFixed(2);
                const issBound = issC * state.delta / (1 - rho + 1e-8);
                document.getElementById('iss-bound').textContent = issBound.toFixed(3);
                
                // Perturbation display
                document.getElementById('delta-display').textContent = state.delta.toFixed(2);
                document.getElementById('credibility-display').textContent = state.credibility.toFixed(2);
                document.getElementById('misinfo-display').textContent = state.misinfo.toFixed(2);
                
                // Stability badge
                const badge = document.getElementById('stability-badge');
                if (lipschitz < 1 && rho < 1 && spec < 1) {
                    badge.textContent = 'CONTRACTIVE ‚úì';
                    badge.className = 'badge badge-stable';
                } else {
                    badge.textContent = 'WARNING: Unstable parameters';
                    badge.className = 'badge badge-danger';
                }
                
                // Draw canvases
                drawTrajectory();
                drawPhaseSpace();
                drawHeatmap();
            }

            // ==================== CANVAS DRAWING ====================
            function drawTrajectory() {
                const canvas = document.getElementById('trajectory-canvas');
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                
                ctx.clearRect(0, 0, w, h);
                
                if (state.history.length < 2) return;
                
                // Draw theoretical bound œÅ^t
                const rho = state.rho;
                ctx.beginPath();
                ctx.strokeStyle = '#00b8ff';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 3]);
                for (let i = 0; i < w; i += 5) {
                    const t = i / w * 20;  // scale for visibility
                    const y = h/2 - (Math.pow(rho, t) * h/2);
                    if (i === 0) ctx.moveTo(i, y);
                    else ctx.lineTo(i, y);
                }
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw actual norm trajectory
                ctx.beginPath();
                ctx.strokeStyle = '#00ffaa';
                ctx.lineWidth = 2;
                const stepX = w / (state.history.length - 1);
                for (let i = 0; i < state.history.length; i++) {
                    const x = i * stepX;
                    const y = h/2 - (state.history[i].norm * h/2);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            function drawPhaseSpace() {
                const canvas = document.getElementById('phase-canvas');
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                
                ctx.clearRect(0, 0, w, h);
                
                // Draw axes
                ctx.strokeStyle = '#2a3a4a';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, h/2);
                ctx.lineTo(w, h/2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(w/2, 0);
                ctx.lineTo(w/2, h);
                ctx.stroke();
                
                // Draw trajectory in phase space (E0 vs I)
                if (state.history.length < 2) return;
                
                ctx.beginPath();
                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                for (let i = 0; i < state.history.length; i++) {
                    const x = w/2 + (state.history[i].E0 * w/2);
                    const y = h/2 - (state.history[i].I * h/2);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                // Draw current point
                if (state.history.length > 0) {
                    const last = state.history[state.history.length - 1];
                    const x = w/2 + (last.E0 * w/2);
                    const y = h/2 - (last.I * h/2);
                    ctx.beginPath();
                    ctx.fillStyle = '#00b8ff';
                    ctx.arc(x, y, 5, 0, 2*Math.PI);
                    ctx.fill();
                }
            }

            function drawHeatmap() {
                const canvas = document.getElementById('heatmap-canvas');
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                
                ctx.clearRect(0, 0, w, h);
                
                // Draw spectral radius heatmap over (Œ≥,Œ∑) with current Œº
                const mu = state.mu;
                const steps = 20;
                for (let i = 0; i < steps; i++) {
                    for (let j = 0; j < steps; j++) {
                        const gamma = i / (steps - 1);
                        const eta = j / (steps - 1);
                        // Approximate spectral radius using worst‚Äëcase a = gamma
                        const a = gamma;
                        const lam3 = 1 - mu;
                        const b = 2 - gamma - eta;
                        const c = (1 - gamma)*(1 - eta) - a * eta;
                        const disc = b*b - 4*c;
                        let rho;
                        if (disc >= 0) {
                            const lam1 = (b + Math.sqrt(disc)) / 2;
                            const lam2 = (b - Math.sqrt(disc)) / 2;
                            rho = Math.max(lam1, lam2, lam3);
                        } else {
                            rho = Math.max(Math.sqrt(c), lam3);
                        }
                        const x = i * (w / steps);
                        const y = j * (h / steps);
                        const size = w / steps;
                        const intensity = Math.min(1, rho);
                        const r = Math.floor(100 + 155 * intensity);
                        const g = Math.floor(100 + 155 * (1 - intensity));
                        const b_ = 255;
                        ctx.fillStyle = `rgb(${r}, ${g}, ${b_})`;
                        ctx.fillRect(x, y, size, size);
                    }
                }
            }

            // ==================== EVENT HANDLERS ====================
            // Sliders
            document.getElementById('gamma-slider').addEventListener('input', (e) => {
                state.gamma = parseFloat(e.target.value);
                updateUI();
            });
            document.getElementById('eta-slider').addEventListener('input', (e) => {
                state.eta = parseFloat(e.target.value);
                updateUI();
            });
            document.getElementById('mu-slider').addEventListener('input', (e) => {
                state.mu = parseFloat(e.target.value);
                updateUI();
            });
            document.getElementById('lr-slider').addEventListener('input', (e) => {
                state.LR = parseFloat(e.target.value);
                updateUI();
            });
            document.getElementById('delta-slider').addEventListener('input', (e) => {
                state.delta = parseFloat(e.target.value);
                updateUI();
            });
            document.getElementById('credibility-slider').addEventListener('input', (e) => {
                state.credibility = parseFloat(e.target.value);
                updateUI();
            });
            document.getElementById('misinfo-slider').addEventListener('input', (e) => {
                state.misinfo = parseFloat(e.target.value);
                updateUI();
            });

            // Buttons
            document.getElementById('inject-perturb').addEventListener('click', () => {
                // Inject a single perturbation
                const perturb = state.delta * (2 * Math.random() - 1);
                state.Lt = clamp(state.Lt + perturb, -1, 1);
                step();
            });

            document.getElementById('toggle-perturb').addEventListener('click', (btn) => {
                state.continuousNoise = !state.continuousNoise;
                btn.textContent = state.continuousNoise ? '‚è∏Ô∏è Stop noise' : 'üîÑ Continuous noise';
                btn.style.background = state.continuousNoise ? 'rgba(255,77,109,0.2)' : '';
            });

            document.getElementById('reset-state').addEventListener('click', () => {
                state.E0 = 0;
                state.I = 0;
                state.Lt = 0;
                state.history = [];
                updateUI();
            });

            document.getElementById('toggle-montecarlo').addEventListener('click', () => {
                runMonteCarlo();
                // Overlay MC trajectories on main plot? For simplicity, just update UI and maybe draw.
                // We'll just show a count.
                alert(`Monte Carlo ran ${state.mcTrajectories.length} trajectories.`);
            });

            document.getElementById('high-credibility').addEventListener('click', () => {
                state.credibility = 0.95;
                state.misinfo = 0.05;
                document.getElementById('credibility-slider').value = '0.95';
                document.getElementById('misinfo-slider').value = '0.05';
                updateUI();
            });

            document.getElementById('fake-news').addEventListener('click', () => {
                state.credibility = 0.1;
                state.misinfo = 0.9;
                document.getElementById('credibility-slider').value = '0.1';
                document.getElementById('misinfo-slider').value = '0.9';
                updateUI();
            });

            // Auto-step every 200ms
            setInterval(() => {
                step();
            }, 200);

            // Initialize
            updateUI();
        })();
    </script>
</body>
</html>