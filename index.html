<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AURA-X Œ© ‚Äî ULTIMATE EMOTIONAL INTELLIGENCE</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;800;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg0: #020608; --bg1: #060d14; --bg2: #0a1520; --bg3: #0f1e2e;
      --surface: rgba(10,22,38,0.92); --border: rgba(0,210,255,0.15); --border-hot: rgba(0,210,255,0.55);
      --cyan: #00d2ff; --cyan2: #00f5ff; --gold: #ffd700; --amber: #ffaa00; --red: #ff3860;
      --green: #00ff88; --purple: #c084fc; --white: #e8f4ff; --muted: #4a6f8a;
      --font-mono: 'Share Tech Mono', monospace; --font-ui: 'Exo 2', sans-serif; --font-label: 'Rajdhani', sans-serif;
      --glow-cyan: 0 0 20px rgba(0,210,255,0.4), 0 0 60px rgba(0,210,255,0.15);
      --glow-gold: 0 0 20px rgba(255,215,0,0.5), 0 0 60px rgba(255,215,0,0.2);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-ui); background: var(--bg0); color: var(--white);
      min-height: 100vh; overflow-x: hidden; position: relative;
    }
    body::before {
      content: ''; position: fixed; inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.07) 2px, rgba(0,0,0,0.07) 4px);
      pointer-events: none; z-index: 9999;
    }
    .grid-bg {
      position: fixed; inset: 0;
      background-image: linear-gradient(rgba(0,210,255,0.04) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0,210,255,0.04) 1px, transparent 1px);
      background-size: 40px 40px; animation: gridDrift 20s linear infinite;
      pointer-events: none; z-index: 0;
    }
    @keyframes gridDrift { 0% { background-position: 0 0; } 100% { background-position: 40px 40px; } }
    #particleCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 1; opacity: 0.3; }
    .shell { position: relative; z-index: 10; max-width: 1400px; margin: 0 auto; padding: 0 16px 40px; }
    header { padding: 20px 0 12px; text-align: center; }
    .logo-wrap { width: 72px; height: 72px; margin: 0 auto 10px; position: relative; }
    .logo-wrap svg { width: 100%; height: 100%; }
    .orbit-g { transform-origin: 36px 36px; animation: orbit 4s linear infinite; }
    @keyframes orbit { to { transform: rotate(360deg); } }
    .header-title {
      font-size: clamp(26px, 5vw, 50px); font-weight: 900; letter-spacing: 4px; text-transform: uppercase;
      background: linear-gradient(135deg, var(--cyan), var(--cyan2), var(--gold));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      filter: drop-shadow(0 0 30px rgba(0,210,255,0.5)); line-height: 1;
    }
    .header-sub { font-family: var(--font-label); font-size: 12px; color: var(--muted); letter-spacing: 3px; margin-top: 5px; text-transform: uppercase; }
    .status-bar {
      display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-top: 12px;
      font-family: var(--font-mono); font-size: 11px;
    }
    .status-pill {
      padding: 3px 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface);
      color: var(--cyan); display: flex; align-items: center; gap: 5px;
    }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px var(--green); animation: sDot 2s ease-in-out infinite; }
    @keyframes sDot { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    .main-grid { display: grid; grid-template-columns: 1fr 360px; gap: 14px; margin-top: 14px; }
    @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    .card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
      backdrop-filter: blur(12px); transition: border-color 0.3s;
    }
    .card:hover { border-color: var(--border-hot); }
    .card-head {
      padding: 9px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 7px;
      background: rgba(0,210,255,0.04);
    }
    .card-icon { font-size: 13px; }
    .card-title { font-family: var(--font-label); font-size: 12px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--cyan); }
    .card-badge { margin-left: auto; font-family: var(--font-mono); font-size: 9px; color: var(--muted); }
    .card-body { padding: 14px; }

    /* Emotional Core */
    .emo-core { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 16px; }
    .e0-ring-wrap { position: relative; width: 180px; height: 180px; }
    #e0RingSvg { width: 100%; height: 100%; }
    .e0-center {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      text-align: center;
    }
    .e0-val { font-family: var(--font-mono); font-size: 34px; font-weight: 700; color: var(--cyan); text-shadow: var(--glow-cyan); line-height: 1; }
    .e0-label { font-family: var(--font-label); font-size: 10px; letter-spacing: 3px; color: var(--muted); margin-top: 2px; }
    .emotion-name { font-size: 20px; font-weight: 800; letter-spacing: 3px; text-align: center; transition: all 0.5s; }
    .emotion-desc { font-size: 12px; color: var(--muted); text-align: center; font-style: italic; max-width: 260px; line-height: 1.5; }

    /* Live Equation */
    .eq-row { display: flex; flex-direction: column; gap: 5px; font-family: var(--font-mono); font-size: 11px; }
    .eq-line {
      display: flex; justify-content: space-between; align-items: center; padding: 5px 9px;
      background: rgba(0,0,0,0.3); border-radius: 5px; border-left: 2px solid var(--border); transition: all 0.4s;
    }
    .eq-line.active { border-left-color: var(--cyan); background: rgba(0,210,255,0.06); }
    .eq-key { color: var(--muted); }
    .eq-val { color: var(--cyan2); font-weight: 700; }
    .eq-formula { margin-top: 7px; padding: 7px; background: rgba(0,0,0,0.4); border-radius: 7px; border: 1px solid rgba(0,210,255,0.1); font-size: 10px; color: rgba(0,210,255,0.7); text-align: center; }

    /* Parameters */
    .param-grid { display: flex; flex-direction: column; gap: 9px; }
    .param-row { display: flex; flex-direction: column; gap: 3px; }
    .param-label { display: flex; justify-content: space-between; font-family: var(--font-label); font-size: 11px; letter-spacing: 1px; }
    .param-name { color: var(--muted); }
    .param-val { color: var(--cyan); font-family: var(--font-mono); }
    input[type=range] {
      -webkit-appearance: none; width: 100%; height: 3px; background: rgba(0,210,255,0.15);
      border-radius: 2px; outline: none; cursor: pointer;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 13px; height: 13px; border-radius: 50%; background: var(--cyan);
      box-shadow: var(--glow-cyan); cursor: pointer; transition: transform 0.2s;
    }
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.4); }
    .gamma-visual { display: flex; align-items: center; gap: 7px; font-family: var(--font-mono); font-size: 10px; color: var(--muted); margin-top: 5px; }
    .gamma-bar { flex: 1; height: 4px; background: rgba(0,0,0,0.4); border-radius: 2px; overflow: hidden; }
    .gamma-fill { height: 100%; background: linear-gradient(90deg, var(--green), var(--amber), var(--red)); border-radius: 2px; transition: width 0.3s; }

    /* Chat */
    .chat-area { display: flex; flex-direction: column; height: 400px; }
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 9px;
      scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    }
    .msg { display: flex; gap: 7px; animation: msgIn 0.4s cubic-bezier(0.34,1.56,0.64,1); }
    @keyframes msgIn { from { opacity: 0; transform: translateY(10px) scale(0.96); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .msg-avatar {
      width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 13px; flex-shrink: 0; border: 1px solid var(--border);
    }
    .msg.user { flex-direction: row-reverse; }
    .msg.user .msg-avatar { background: rgba(255,215,0,0.1); border-color: rgba(255,215,0,0.3); }
    .msg.aura .msg-avatar { background: rgba(0,210,255,0.1); border-color: rgba(0,210,255,0.3); }
    .msg-bubble { max-width: 80%; padding: 8px 12px; border-radius: 11px; font-size: 13px; line-height: 1.55; }
    .msg.user .msg-bubble { background: rgba(255,215,0,0.09); border: 1px solid rgba(255,215,0,0.2); border-radius: 11px 3px 11px 11px; }
    .msg.aura .msg-bubble { background: rgba(0,210,255,0.06); border: 1px solid rgba(0,210,255,0.18); border-radius: 3px 11px 11px 11px; }
    .msg-meta { font-family: var(--font-mono); font-size: 9px; color: var(--muted); margin-top: 3px; display: flex; gap: 7px; flex-wrap: wrap; }
    .msg.user .msg-meta { justify-content: flex-end; }
    .emotion-tag { display: inline-flex; align-items: center; gap: 2px; padding: 1px 5px; border-radius: 3px; font-size: 9px; font-family: var(--font-mono); border: 1px solid; }

    .typing-indicator {
      display: flex; gap: 4px; padding: 10px 14px; background: rgba(0,210,255,0.06);
      border: 1px solid rgba(0,210,255,0.18); border-radius: 3px 11px 11px 11px; width: fit-content;
    }
    .typing-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--cyan); animation: typBounce 1.2s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typBounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

    .chat-input-row { display: flex; gap: 7px; padding: 10px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); align-items: flex-end; }
    .chat-input {
      flex: 1; background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 7px; padding: 8px 12px;
      color: var(--white); font-family: var(--font-ui); font-size: 13px; outline: none; transition: border-color 0.3s; resize: none; min-height: 42px; max-height: 120px;
    }
    .chat-input:focus { border-color: var(--cyan2); box-shadow: 0 0 0 2px rgba(0,210,255,0.1); }
    .chat-input::placeholder { color: var(--muted); }
    .input-action-btn {
      width: 42px; height: 42px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 18px; flex-shrink: 0; transition: all 0.2s; background: rgba(255,255,255,0.06); color: var(--text2);
    }
    .input-action-btn:hover { background: rgba(0,210,255,0.15); color: var(--cyan); }
    .btn-mic.recording { background: rgba(255,77,109,0.2); color: var(--red); animation: pulse 1s infinite; }
    @keyframes pulse { 50% { box-shadow: 0 0 0 8px rgba(255,77,109,0.15); } }
    .btn-send { background: linear-gradient(135deg, var(--cyan), #0088cc); color: #fff; width: 42px; height: 42px; border-radius: 50%; }
    .btn-send:hover { filter: brightness(1.1); }
    .btn-attach { background: rgba(255,255,255,0.06); color: var(--text2); }
    .btn-attach:hover { background: rgba(0,210,255,0.15); color: var(--cyan); }

    .btn {
      padding: 8px 16px; border: none; border-radius: 7px; cursor: pointer;
      font-family: var(--font-label); font-size: 12px; font-weight: 700; letter-spacing: 1px;
      text-transform: uppercase; transition: all 0.2s;
    }
    .btn-primary { background: linear-gradient(135deg, var(--cyan), rgba(0,180,220,0.8)); color: var(--bg0); box-shadow: var(--glow-cyan); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 0 30px rgba(0,210,255,0.6); }
    .btn-sm { padding: 4px 9px; font-size: 10px; border-radius: 4px; }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); }
    .btn-ghost:hover { border-color: var(--cyan); color: var(--cyan); }

    .behaviour-box {
      padding: 11px; background: rgba(0,0,0,0.4); border-radius: 7px; border: 1px solid var(--border);
      font-size: 13px; line-height: 1.6; min-height: 56px; color: rgba(255,255,255,0.85); transition: all 0.5s;
    }
    .behaviour-box.positive { border-color: rgba(0,255,136,0.4); }
    .behaviour-box.negative { border-color: rgba(255,56,96,0.4); }
    .feedback-row { display: flex; gap: 7px; margin-top: 7px; justify-content: center; }
    .fb-btn {
      padding: 4px 12px; border-radius: 18px; border: 1px solid; background: transparent;
      cursor: pointer; font-size: 11px; font-family: var(--font-label); letter-spacing: 1px; transition: all 0.2s;
    }
    .fb-pos { border-color: rgba(0,255,136,0.4); color: var(--green); }
    .fb-pos:hover { background: rgba(0,255,136,0.1); }
    .fb-neg { border-color: rgba(255,56,96,0.4); color: var(--red); }
    .fb-neg:hover { background: rgba(255,56,96,0.1); }

    .bottom-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: 14px; }
    @media (max-width: 900px) { .bottom-row { grid-template-columns: 1fr; } }
    .decision-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .dec-cell {
      padding: 7px 5px; border-radius: 7px; border: 1px solid var(--border); background: rgba(0,0,0,0.3);
      text-align: center; font-size: 10px; transition: all 0.4s;
    }
    .dec-cell .dec-icon { font-size: 16px; display: block; margin-bottom: 2px; }
    .dec-cell .dec-label { color: var(--muted); font-family: var(--font-label); letter-spacing: 1px; font-size: 9px; }
    .dec-cell .dec-pct { font-family: var(--font-mono); color: var(--cyan); font-size: 11px; margin-top: 1px; }
    .dec-cell.dominant { border-color: var(--cyan); background: rgba(0,210,255,0.08); box-shadow: 0 0 12px rgba(0,210,255,0.12); }

    /* Right stack */
    .right-stack { display: flex; flex-direction: column; gap: 14px; }

    /* Truth Resonance */
    .truth-meter { display: flex; flex-direction: column; gap: 3px; }
    .truth-label { display: flex; justify-content: space-between; font-size: 10px; font-family: var(--font-mono); }
    .truth-bar-bg { height: 5px; background: rgba(0,0,0,0.4); border-radius: 3px; overflow: hidden; }
    .truth-bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s, background 0.6s; }

    /* BM Memory */
    .memory-list { display: flex; flex-direction: column; gap: 5px; max-height: 240px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
    .mem-item {
      padding: 7px 9px; background: rgba(0,0,0,0.35); border-radius: 6px; border: 1px solid rgba(0,210,255,0.08);
      font-size: 11px; transition: all 0.3s; cursor: pointer;
    }
    .mem-item:hover { border-color: var(--border-hot); }
    .mem-item.active-mem { border-color: var(--cyan); box-shadow: inset 0 0 8px rgba(0,210,255,0.07); }
    .mem-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    .mem-tag { font-family: var(--font-mono); font-size: 8px; padding: 1px 5px; border-radius: 3px; border: 1px solid var(--border); color: var(--muted); }
    .mem-weight { font-family: var(--font-mono); font-size: 9px; color: var(--amber); }
    .mem-text { color: rgba(255,255,255,0.7); line-height: 1.4; }
    .mem-bar-wrap { margin-top: 3px; background: rgba(0,0,0,0.4); height: 2px; border-radius: 1px; }
    .mem-bar { height: 100%; border-radius: 1px; transition: width 0.5s; background: linear-gradient(90deg, var(--cyan), var(--gold)); }

    /* Personality */
    .persona-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
    .persona-item { padding: 5px 7px; border-radius: 5px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); }
    .persona-name { font-size: 9px; color: var(--muted); font-family: var(--font-label); letter-spacing: 1px; text-transform: uppercase; }
    .persona-bar-bg { height: 3px; background: rgba(0,0,0,0.4); border-radius: 2px; margin-top: 3px; overflow: hidden; }
    .persona-bar-fill { height: 100%; border-radius: 2px; transition: width 0.8s; }

    /* Self-learning stats */
    .learn-stat { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(0,210,255,0.06); font-size: 11px; }
    .learn-stat:last-child { border-bottom: none; }
    .learn-key { color: var(--muted); font-family: var(--font-label); }
    .learn-val { color: var(--cyan2); font-family: var(--font-mono); }

    /* Attach preview */
    .attach-preview {
      display: none; padding: 6px 14px; flex-shrink: 0; align-items: center; gap: 8px;
    }
    .attach-preview.show { display: flex; }
    .attach-preview img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
    .remove-attach { background: rgba(255,77,109,0.2); color: var(--red); border: none; border-radius: 8px; padding: 4px 8px; cursor: pointer; font-size: 12px; }

    /* Modals */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 200;
      display: none; align-items: center; justify-content: center; padding: 18px 12px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      width: min(600px, 96vw); border-radius: 18px; overflow: hidden;
      background: rgba(10,18,30,0.97); border: 1px solid var(--border);
      backdrop-filter: blur(12px); color: var(--white);
    }
    .modalHeader {
      display: flex; align-items: center; justify-content: space-between; padding: 12px 14px;
      border-bottom: 1px solid var(--border); font-weight: 800;
    }
    .closeX {
      border: none; background: transparent; color: var(--muted); font-size: 22px; cursor: pointer; padding: 0 4px;
    }
    .modalBody { padding: 14px; max-height: 70vh; overflow: auto; }
    .modal input, .modal textarea, .modal select {
      width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.06); border: 1px solid var(--border);
      border-radius: 10px; color: var(--white); font-size: 13px; outline: none; font-family: inherit; margin-bottom: 8px;
    }
    .modal .m-btns { display: flex; gap: 8px; margin-top: 14px; }

    /* Toast */
    .toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: rgba(0,200,255,0.15); border: 1px solid rgba(0,200,255,0.3); color: var(--cyan);
      padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; z-index: 300;
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2s forwards; pointer-events: none;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(-10px); } }

    #phaseCanvas, #trajCanvas { border-radius: 7px; width: 100%; background: rgba(0,0,0,0.2); }
    footer {
      text-align: center; padding: 18px; font-family: var(--font-mono); font-size: 10px;
      color: var(--muted); border-top: 1px solid var(--border); margin-top: 20px;
    }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  </style>
</head>
<body>
<canvas id="particleCanvas"></canvas>
<div class="grid-bg"></div>
<div class="shell">
  <header>
    <div class="logo-wrap">
      <svg viewBox="0 0 72 72">
        <circle cx="36" cy="36" r="32" fill="none" stroke="rgba(0,210,255,0.15)" stroke-width="1"/>
        <circle cx="36" cy="36" r="24" fill="rgba(0,210,255,0.05)" stroke="rgba(0,210,255,0.3)" stroke-width="1"/>
        <text x="36" y="43" text-anchor="middle" fill="rgba(0,210,255,0.9)" font-size="20" font-weight="bold">Œ©</text>
        <g class="orbit-g">
          <circle cx="36" cy="4" r="3" fill="var(--gold)" opacity="0.9"/>
          <circle cx="36" cy="68" r="2" fill="rgba(0,210,255,0.6)"/>
        </g>
      </svg>
    </div>
    <div class="header-title">AURA-X Œ©</div>
    <div class="header-sub">ULTIMATE EMOTIONAL INTELLIGENCE ¬∑ Patent GB2518804.6</div>
    <div class="status-bar">
      <div class="status-pill"><div class="status-dot"></div>AECN 4.0</div>
      <div class="status-pill"><div class="status-dot"></div>DUAL MEMORY</div>
      <div class="status-pill"><div class="status-dot" style="background:var(--gold);"></div>SELF-LEARNING</div>
      <div class="status-pill"><div class="status-dot" style="background:var(--purple);"></div>Œ≥-SMOOTHING</div>
      <div class="status-pill" id="sessionPill">SESSION: 0:00</div>
    </div>
  </header>

  <div class="main-grid">
    <div style="display:flex; flex-direction:column; gap:14px;">
      <div class="card">
        <div class="card-head"><span class="card-icon">üí¨</span><span class="card-title">Interaction Interface</span><span class="card-badge" id="turnCount">TURN 0</span><button class="btn btn-sm btn-ghost" onclick="clearChat()">RESET</button></div>
        <div class="chat-area">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-row">
            <input type="file" id="attachFile" accept="image/*" style="display:none">
            <button class="input-action-btn btn-attach" onclick="document.getElementById('attachFile').click()">üìé</button>
            <textarea class="chat-input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶" rows="1"></textarea>
            <button class="input-action-btn btn-mic" id="micBtn" onclick="toggleMic()">üé§</button>
            <button class="input-action-btn btn-send" onclick="sendMessage()">‚û§</button>
          </div>
          <div class="attach-preview" id="attachPreview">
            <img id="attachImg" src="" alt="preview">
            <span id="attachName" style="flex:1; font-size:12px;"></span>
            <button class="remove-attach" onclick="clearAttachment()">‚úï</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><span class="card-icon">üß†</span><span class="card-title">Behavioural Output</span><span class="card-badge" id="behaviourMode">NEUTRAL</span></div>
        <div class="card-body">
          <div class="behaviour-box" id="behaviourBox">Awaiting interaction‚Ä¶</div>
          <div class="feedback-row">
            <button class="fb-btn fb-pos" onclick="feedback(1)">‚ñ≤ POSITIVE</button>
            <button class="fb-btn fb-neg" onclick="feedback(-1)">‚ñº NEGATIVE</button>
          </div>
        </div>
      </div>

      <div class="bottom-row">
        <div class="card">
          <div class="card-head"><span class="card-icon">üåÄ</span><span class="card-title">Phase Space</span></div>
          <div class="card-body" style="padding:8px;"><canvas id="phaseCanvas" width="240" height="200"></canvas></div>
        </div>
        <div class="card">
          <div class="card-head"><span class="card-icon">üìà</span><span class="card-title">E‚ÇÄ Trajectory</span></div>
          <div class="card-body" style="padding:8px;"><canvas id="trajCanvas" height="200"></canvas></div>
        </div>
        <div class="card">
          <div class="card-head"><span class="card-icon">‚ö°</span><span class="card-title">Decision Matrix</span></div>
          <div class="card-body">
            <div class="decision-grid" id="decisionGrid">
              <div class="dec-cell" id="dec-engage"><span class="dec-icon">ü§ù</span><div class="dec-label">ENGAGE</div><div class="dec-pct" id="dp-engage">0%</div></div>
              <div class="dec-cell" id="dec-comfort"><span class="dec-icon">üíñ</span><div class="dec-label">COMFORT</div><div class="dec-pct" id="dp-comfort">0%</div></div>
              <div class="dec-cell" id="dec-warn"><span class="dec-icon">‚ö†Ô∏è</span><div class="dec-label">WARN</div><div class="dec-pct" id="dp-warn">0%</div></div>
              <div class="dec-cell" id="dec-inspire"><span class="dec-icon">üî•</span><div class="dec-label">INSPIRE</div><div class="dec-pct" id="dp-inspire">0%</div></div>
              <div class="dec-cell" id="dec-clarify"><span class="dec-icon">üîç</span><div class="dec-label">CLARIFY</div><div class="dec-pct" id="dp-clarify">0%</div></div>
              <div class="dec-cell" id="dec-protect"><span class="dec-icon">üõ°Ô∏è</span><div class="dec-label">PROTECT</div><div class="dec-pct" id="dp-protect">0%</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="right-stack">
      <div class="card">
        <div class="card-head"><span class="card-icon">‚ú®</span><span class="card-title">Emotional Core</span><span class="card-badge">E‚ÇÄ ENGINE</span></div>
        <div class="card-body" style="padding:10px;">
          <div class="emo-core">
            <div class="e0-ring-wrap">
              <svg id="e0RingSvg" viewBox="0 0 180 180">
                <defs><linearGradient id="ag" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#ff3860"/><stop offset="50%" stop-color="#00d2ff"/><stop offset="100%" stop-color="#00ff88"/></linearGradient></defs>
                <circle cx="90" cy="90" r="78" fill="none" stroke="rgba(0,210,255,0.07)" stroke-width="14"/>
                <circle cx="90" cy="90" r="78" fill="none" stroke="rgba(0,210,255,0.12)" stroke-width="0.5"/>
                <circle id="e0Arc" cx="90" cy="90" r="78" fill="none" stroke="url(#ag)" stroke-width="11" stroke-linecap="round" stroke-dasharray="490" stroke-dashoffset="490" transform="rotate(-90 90 90)" style="transition:stroke-dashoffset 0.8s cubic-bezier(0.34,1.2,0.64,1),stroke 0.5s;"/>
                <g id="ticks"></g>
              </svg>
              <div class="e0-center"><div class="e0-val" id="e0Display">0.000</div><div class="e0-label">E‚ÇÄ STATE</div></div>
            </div>
            <div class="emotion-name" id="emotionName">üåÄ INITIALIZING</div>
            <div class="emotion-desc" id="emotionDesc">Grand Emotional Continuity Equation activating‚Ä¶</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><span class="card-icon">Œ£</span><span class="card-title">Live Equation</span></div>
        <div class="card-body">
          <div class="eq-row">
            <div class="eq-line" id="eq-R"><span class="eq-key">R(TM,BM)</span><span class="eq-val" id="eq-R-val">0.000</span></div>
            <div class="eq-line" id="eq-D"><span class="eq-key">D(t)</span><span class="eq-val" id="eq-D-val">0.000</span></div>
            <div class="eq-line" id="eq-Lf"><span class="eq-key">Œª_faith</span><span class="eq-val" id="eq-Lf-val">0.000</span></div>
            <div class="eq-line" id="eq-Ls"><span class="eq-key">Œª_sys</span><span class="eq-val" id="eq-Ls-val">0.000</span></div>
            <div class="eq-line" id="eq-Lt"><span class="eq-key">Œª_trc</span><span class="eq-val" id="eq-Lt-val">0.000</span></div>
            <div class="eq-line" id="eq-X" style="background:rgba(0,210,255,0.06);border-left:2px solid var(--cyan)"><span class="eq-key">X = R‚àíD+Œ£Œª</span><span class="eq-val" id="eq-X-val">0.000</span></div>
            <div class="eq-line" style="background:rgba(0,210,255,0.1);border-left:3px solid var(--cyan2)"><span class="eq-key" style="color:var(--cyan2)">E‚ÇÄ = tanh(X)</span><span class="eq-val" id="eq-E0-val" style="color:var(--cyan2);">0.000</span></div>
          </div>
          <div class="eq-formula">E‚ÇÄ(t+1) = (1‚àíŒ≥)¬∑E‚ÇÄ(t) + Œ≥¬∑tanh(R‚àíD+Œª_f+Œª_s+Œª_t)</div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><span class="card-icon">‚öôÔ∏è</span><span class="card-title">Parameters</span></div>
        <div class="card-body">
          <div class="param-grid">
            <div class="param-row"><div class="param-label"><span class="param-name">Decay (D)</span><span class="param-val" id="pv-D">0.30</span></div><input type="range" min="0" max="1" step="0.01" value="0.30" oninput="updateParam('D',this.value)"></div>
            <div class="param-row"><div class="param-label"><span class="param-name">Œª Faith</span><span class="param-val" id="pv-Lf">0.10</span></div><input type="range" min="-1" max="1" step="0.01" value="0.10" oninput="updateParam('Lf',this.value)"></div>
            <div class="param-row"><div class="param-label"><span class="param-name">Œª System</span><span class="param-val" id="pv-Ls">0.10</span></div><input type="range" min="-0.5" max="0.5" step="0.01" value="0.10" oninput="updateParam('Ls',this.value)"></div>
            <div class="param-row"><div class="param-label"><span class="param-name">Œª Truth</span><span class="param-val" id="pv-Lt">0.00</span></div><input type="range" min="-1" max="1" step="0.01" value="0.00" oninput="updateParam('Lt',this.value)"></div>
            <div class="param-row">
              <div class="param-label"><span class="param-name">Œ≥ Smooth</span><span class="param-val" id="pv-gamma">0.30</span></div>
              <input type="range" min="0.01" max="0.99" step="0.01" value="0.30" oninput="updateParam('gamma',this.value)">
              <div class="gamma-visual"><span>INERTIAL</span><div class="gamma-bar"><div class="gamma-fill" id="gammaFill" style="width:30%"></div></div><span>REACTIVE</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><span class="card-icon">üîç</span><span class="card-title">Truth Resonance</span></div>
        <div class="card-body">
          <div style="display:flex; flex-direction:column; gap:7px;">
            <div class="truth-meter"><div class="truth-label"><span>Factual Confidence</span><span id="truthPct">100%</span></div><div class="truth-bar-bg"><div class="truth-bar-fill" id="truthBar" style="width:100%; background:var(--green);"></div></div></div>
            <div class="truth-meter"><div class="truth-label"><span>Sentiment Tone</span><span id="sentPct">0%</span></div><div class="truth-bar-bg"><div class="truth-bar-fill" id="sentBar" style="width:50%; background:var(--cyan);"></div></div></div>
            <div class="truth-meter"><div class="truth-label"><span>Emotional Intensity</span><span id="intPct">0%</span></div><div class="truth-bar-bg"><div class="truth-bar-fill" id="intBar" style="width:0%; background:var(--amber);"></div></div></div>
            <div id="trcAlert" style="display:none; padding:5px 8px; border:1px solid var(--amber); border-radius:5px; background:rgba(255,170,0,0.1); color:var(--amber);"><span>‚ö†Ô∏è</span><span id="trcMsg"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px;">
    <div class="card">
      <div class="card-head"><span class="card-icon">üìò</span><span class="card-title">Bold Memory (BM)</span><span class="card-badge" id="bmCount">0 EPISODES</span><button class="btn btn-sm btn-ghost" onclick="exportBM()">EXPORT</button></div>
      <div class="card-body">
        <div class="memory-list" id="memoryList"><div style="text-align:center; color:var(--muted); padding:18px;">No memories stored yet. Begin interacting‚Ä¶</div></div>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; gap:14px;">
      <div class="card">
        <div class="card-head"><span class="card-icon">üß¨</span><span class="card-title">Personality Matrix</span></div>
        <div class="card-body"><div class="persona-grid" id="personaGrid"></div></div>
      </div>
      <div class="card">
        <div class="card-head"><span class="card-icon">üìö</span><span class="card-title">Self-Learning Engine</span></div>
        <div class="card-body">
          <div class="learn-stat"><span class="learn-key">Total Updates</span><span class="learn-val" id="ls-updates">0</span></div>
          <div class="learn-stat"><span class="learn-key">Learning Rate (Œ∑)</span><span class="learn-val">0.05</span></div>
          <div class="learn-stat"><span class="learn-key">BM Adaptations</span><span class="learn-val" id="ls-adapt">0</span></div>
          <div class="learn-stat"><span class="learn-key">Volatility œÉ</span><span class="learn-val" id="ls-vol">0.0000</span></div>
          <div class="learn-stat"><span class="learn-key">Energy ‚Ñ∞</span><span class="learn-val" id="ls-energy">0.0000</span></div>
          <div class="learn-stat"><span class="learn-key">AECN Norm</span><span class="learn-val" id="ls-norm">0.5000</span></div>
          <div class="learn-stat"><span class="learn-key">Jump Index J(t)</span><span class="learn-val" id="ls-jump">0.0000</span></div>
          <div class="learn-stat"><span class="learn-key">E‚ÇÅ (AECN)</span><span class="learn-val" id="ls-e1">0.0000</span></div>
          <div class="learn-stat"><span class="learn-key">E‚ÇÑ (AECN)</span><span class="learn-val" id="ls-e4">0.0000</span></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    AURA-X Œ© Ultimate Prototype ¬∑ Author: Alim ul Haq Khan ¬∑ Patent GB2518804.6<br>
    E‚ÇÄ = tanh(R(TM,BM) ‚àí D + Œª_faith + Œª_sys + Œª_trc) ¬∑ Œ≥-smoothing ¬∑ self-learning ¬∑ voice/LLM/image
  </footer>
</div>

<!-- LLM Modal -->
<div class="modal-overlay" id="llmModal">
  <div class="modal">
    <div class="modalHeader"><span>ü§ñ LLM Connection</span><button class="closeX" onclick="closeModal('llmModal')">‚úï</button></div>
    <div class="modalBody">
      <label>Provider</label>
      <select id="apiProvider"><option value="openai">OpenAI</option><option value="anthropic">Anthropic</option></select>
      <label>Model</label>
      <select id="apiModel"><option value="gpt-4o-mini">GPT-4o Mini</option></select>
      <label>API Key</label><input type="password" id="apiKey" placeholder="Enter API key...">
      <div id="apiStatus" style="margin-top:8px; font-size:12px;"></div>
      <div class="m-btns">
        <button class="btn btn-primary" onclick="connectLLM()">Connect</button>
        <button class="btn btn-ghost" onclick="closeModal('llmModal')">Close</button>
        <button class="btn btn-ghost danger" id="disconnectLLM" style="display:none;" onclick="disconnectLLM()">Disconnect</button>
      </div>
    </div>
  </div>
</div>

<!-- Intelligence Modal -->
<div class="modal-overlay" id="intelModal">
  <div class="modal">
    <div class="modalHeader"><span>üß† Intelligence Folder</span><button class="closeX" onclick="closeModal('intelModal')">‚úï</button></div>
    <div class="modalBody">
      <input id="intelSearch" placeholder="Search Q&A pairs...">
      <div id="intelList" style="max-height:300px; overflow:auto;"></div>
      <div class="m-btns">
        <button class="btn btn-primary" onclick="addIntel()">‚ûï Add</button>
        <button class="btn btn-ghost" onclick="exportIntel()">üì§ Export</button>
        <button class="btn btn-ghost" onclick="importIntel()">üì• Import</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Intel Modal -->
<div class="modal-overlay" id="intelEditModal">
  <div class="modal">
    <div class="modalHeader"><span id="intelEditTitle">Add Q&A</span><button class="closeX" onclick="closeModal('intelEditModal')">‚úï</button></div>
    <div class="modalBody">
      <label>Question / Trigger</label><textarea id="intelEditQ" placeholder="What the user might say..."></textarea>
      <label>Answer / Response</label><textarea id="intelEditA" placeholder="How AURA should respond..." rows="3"></textarea>
      <div class="m-btns"><button class="btn btn-primary" onclick="saveIntelEdit()">Save</button><button class="btn btn-ghost" onclick="closeModal('intelEditModal')">Cancel</button></div>
    </div>
  </div>
</div>

<!-- Faith Modal (simplified) -->
<div class="modal-overlay" id="faithModal">
  <div class="modal">
    <div class="modalHeader"><span>üïä Faith Selection</span><button class="closeX" onclick="closeModal('faithModal')">‚úï</button></div>
    <div class="modalBody">
      <div style="display:flex; flex-wrap:wrap; gap:8px;" id="faithChips"></div>
    </div>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="importIntelFile" accept=".json" style="display:none">
<div class="toast" id="toast"></div>

<script>
'use strict';

/* ==================== GLOBAL STATE ==================== */
const STATE = {
  // Core emotional parameters
  E0: 0, E0_prev: 0,
  D: 0.30, lf: 0.10, ls: 0.10, lt: 0.00, gamma: 0.30, G: 1.0,
  R: 0, X: 0,
  // AECN layers
  E1: 0, E2: 0, E3: 0, E4: 0,
  // Temporary Memory
  TM: { valence: 0, intensity: 0, topic: '', keywords: [] },
  // Bold Memory (array of episodes)
  BM: [],
  // Personality traits (used for decision and drift)
  personality: { openness: 0.70, conscientiousness: 0.65, empathy: 0.80, resilience: 0.55, assertiveness: 0.45 },
  // Intelligence Q&A
  intelligence: [],
  // Learned responses (auto from feedback)
  learned: [],
  // Faith selection
  faithSelection: [],
  // Stats
  totalUpdates: 0, bmAdaptations: 0,
  history: [],                // E0 history for graphs
  volatilities: [],           // for volatility calculation
  jumpEvents: 0,
  energyHist: [],
  turnCount: 0,
  lastMemIdx: -1,
  fbCooldown: false,
  sessionStart: Date.now(),
  // User feedback correction mode
  correcting: false,
  lastUserQ: '',
  lastAuraA: '',
  // API
  apiConfig: { provider: 'openai', model: 'gpt-4o-mini', key: '' },
  // Voice
  voiceOn: false,
  recognition: null,
  recording: false,
  // Media
  pendingImageData: null,
  pendingImageName: '',
  // Misc
  maxHist: 120,
  editingIntelId: null,
};

/* ==================== CONSTANTS ==================== */
const STORAGE_KEYS = {
  BM: 'AURA_ULTIMATE_BM',
  INTEL: 'AURA_ULTIMATE_INTEL',
  LEARNED: 'AURA_ULTIMATE_LEARNED',
  PERS: 'AURA_ULTIMATE_PERS',
  STATS: 'AURA_ULTIMATE_STATS',
  CFG: 'AURA_ULTIMATE_CFG',
  FAITH: 'AURA_ULTIMATE_FAITH',
  API_PROVIDER: 'AURA_ULTIMATE_API_PROV',
  API_MODEL: 'AURA_ULTIMATE_API_MODEL',
  API_KEY: 'AURA_ULTIMATE_API_KEY'
};

// Emotion lexicon (valence, intensity)
const LEX = {
  joy:[0.9,0.85], happy:[0.85,0.8], love:[0.95,0.9], wonderful:[0.88,0.82],
  great:[0.78,0.7], excellent:[0.85,0.8], amazing:[0.88,0.85], beautiful:[0.82,0.75],
  fantastic:[0.87,0.83], perfect:[0.9,0.85], hope:[0.72,0.65], good:[0.65,0.55],
  kind:[0.7,0.6], proud:[0.78,0.72], excited:[0.83,0.88], grateful:[0.8,0.7],
  inspired:[0.82,0.78], peaceful:[0.72,0.6], calm:[0.6,0.45], trust:[0.75,0.65],
  success:[0.82,0.78], win:[0.8,0.82], victory:[0.85,0.88], achieve:[0.78,0.72],
  progress:[0.72,0.65], learn:[0.68,0.6], grow:[0.7,0.62], help:[0.7,0.6],
  friend:[0.78,0.68], together:[0.72,0.62], courage:[0.82,0.78], strength:[0.8,0.75],
  sad:[-0.78,0.72], angry:[-0.82,0.88], fear:[-0.8,0.85], hate:[-0.9,0.9],
  terrible:[-0.85,0.82], awful:[-0.82,0.8], horrible:[-0.88,0.85], bad:[-0.65,0.6],
  fail:[-0.75,0.78], failure:[-0.8,0.82], broken:[-0.72,0.7],
  lost:[-0.68,0.65], lonely:[-0.78,0.72], pain:[-0.82,0.85], hurt:[-0.78,0.8],
  cry:[-0.72,0.75], grief:[-0.85,0.88], despair:[-0.9,0.92], hopeless:[-0.88,0.88],
  quit:[-0.65,0.7], die:[-0.92,0.95], kill:[-0.9,0.92], lie:[-0.72,0.7],
  useless:[-0.75,0.7], impossible:[-0.55,0.65], worst:[-0.88,0.85],
  storm:[-0.3,0.5], accident:[-0.5,0.7], crash:[-0.6,0.75], trauma:[-0.6,0.8],
  ending:[-0.4,0.6], apocalypse:[-0.7,0.85], afraid:[-0.72,0.78], panic:[-0.82,0.88],
  wrong:[-0.55,0.55], stupid:[-0.68,0.7], never:[-0.45,0.5]
};

const MISINFOPATTERNS = [
  /\bend(?:ing)?\s+(?:of\s+)?(?:the\s+)?world/i,
  /\bworld\s+(?:will\s+)?end/i,
  /\b(?:they|government)\s+(?:are|is)\s+hiding/i,
  /\bsecret\s+(?:cure|knowledge|truth)/i,
  /\bwake\s+up\s+sheeple/i,
  /\b100%\s+(?:proven|guaranteed)\s+cure/i
];

const FAITH_OPTIONS = [
  { id:'none', label:'None' },
  { id:'islam', label:'Islam' },
  { id:'christianity', label:'Christianity' },
  { id:'hinduism', label:'Hinduism' },
  { id:'buddhism', label:'Buddhism' },
  { id:'sikhism', label:'Sikhism' },
  { id:'judaism', label:'Judaism' },
  { id:'atheism', label:'Atheism / Humanism' },
  { id:'mixed', label:'Other / Mixed' },
  { id:'indigenous', label:'Indigenous / Traditional' }
];

// Seed intelligence (common Q&A)
const SEED_INTEL = [
  ['hi','Hey there! Great to hear from you.'],
  ['hello','Hello! How can I help you today?'],
  ['hey','Hey! What would you like to talk about?'],
  ['how are you','I\'m functioning well, thanks! More importantly, how are you?'],
  ['what is your name','My name is AURA-X Œ©, your digital companion.'],
  ['who created you','Alim ul Haq created me at Investor Point Research Cell, Timergara.'],
  ['i love you','That means a lot! I care about you too.'],
  ['i am sad','I\'m here with you. Want to talk about what\'s making you feel this way?'],
  ['i am happy','That\'s wonderful! Tell me what brought you joy.'],
  ['thank you','You\'re very welcome! I\'m always here.'],
  ['bye','Goodbye! Take care, and I\'ll be here when you return.']
];
const SEED_MAP = new Map(SEED_INTEL);

/* ==================== UTILITY FUNCTIONS ==================== */
function loadJSON(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } }
function saveJSON(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }
function saveAll() {
  saveJSON(STORAGE_KEYS.BM, STATE.BM);
  saveJSON(STORAGE_KEYS.INTEL, STATE.intelligence);
  saveJSON(STORAGE_KEYS.LEARNED, STATE.learned);
  saveJSON(STORAGE_KEYS.PERS, STATE.personality);
  saveJSON(STORAGE_KEYS.STATS, { totalUpdates: STATE.totalUpdates, bmAdaptations: STATE.bmAdaptations, turnCount: STATE.turnCount });
  saveJSON(STORAGE_KEYS.FAITH, STATE.faithSelection);
  saveJSON(STORAGE_KEYS.CFG, { voiceOn: STATE.voiceOn, gamma: STATE.gamma, D: STATE.D, lf: STATE.lf, ls: STATE.ls, lt: STATE.lt });
}
function norm(s) { return String(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim(); }
function tokenize(s) { const n = norm(s); return n ? n.split(' ') : []; }
function textSimilarity(a, b) {
  const na = norm(a), nb = norm(b); if (!na || !nb) return 0;
  if (na === nb) return 1;
  if (na.length >= 4 && (nb.includes(na) || na.includes(nb))) return 0.85 * Math.min(na.length, nb.length) / Math.max(na.length, nb.length);
  const ta = tokenize(a), tb = tokenize(b); if (!ta.length || !tb.length) return 0;
  const setA = new Set(ta); let common = 0; for (const w of tb) if (setA.has(w)) common++;
  return (common / Math.max(ta.length, tb.length)) * 0.8;
}
function findBestMatch(list, text, threshold = 0.5) {
  if (!Array.isArray(list) || !list.length) return null;
  let best = null, bestScore = 0;
  for (const item of list) {
    const q = item.q || item[0] || '';
    const score = textSimilarity(text, q);
    if (score > bestScore) { best = item; bestScore = score; }
  }
  return bestScore >= threshold ? { item: best, score: bestScore } : null;
}
function seedLookup(text) {
  const n = norm(text);
  if (SEED_MAP.has(n)) return { answer: SEED_MAP.get(n), score: 1 };
  let best = null, bestScore = 0;
  for (const [q, a] of SEED_MAP) {
    const score = textSimilarity(text, q);
    if (score > bestScore) { best = a; bestScore = score; }
  }
  return bestScore >= 0.5 ? { answer: best, score: bestScore } : null;
}
function toast(msg) {
  const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}
function timestamp() { return new Date().toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' }); }
function escapeHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ==================== TEXT ANALYSIS ==================== */
function analyseText(text) {
  const low = text.toLowerCase();
  let vs = 0, is2 = 0, n = 0;
  const matched = [];
  for (const [w, [v,i]] of Object.entries(LEX)) {
    if (low.includes(w)) { vs += v; is2 += i; n++; matched.push({ word: w, valence: v, intensity: i }); }
  }
  const negW = ['not','no','never',"don't","doesn't","can't","cannot","won't"];
  let neg = negW.some(x => low.includes(x));
  if (neg) vs *= -0.7;
  const intens = ['very','extremely','absolutely','completely','totally','really','deeply'];
  let im = 1.0;
  intens.forEach(x => { if (low.includes(x)) im = Math.min(1.6, im + 0.15); });
  const valence = n > 0 ? Math.tanh(vs / n) : 0;
  const intensity = n > 0 ? Math.min(1, (is2 / n) * im) : 0;
  let misinfo = 0;
  MISINFOPATTERNS.forEach(p => { if (p.test(text)) misinfo += 0.35; });
  if (low.includes('ending soon') || low.includes('world ending')) misinfo += 0.4;
  misinfo = Math.min(1, misinfo);
  const isQ = /\?/.test(text) || /^(what|how|why|when|where|who|which|can|could|would|should|do|does|is|are)\b/i.test(text.trim());
  const traumaW = ['storm','accident','crash','death','loss','trauma','nightmare','scared','terrified','panic'];
  const trauma = traumaW.some(w => low.includes(w));
  return { valence, intensity, misinfo, matched, isQ, trauma };
}

/* ==================== SOFTMAX & RESONANCE ==================== */
function softmax(arr) {
  if (!arr.length) return [];
  const mx = Math.max(...arr);
  const ex = arr.map(x => Math.exp(x - mx));
  const s = ex.reduce((a,b) => a + b, 0) || 1;
  return ex.map(x => x / s);
}

function computeR(TM, BM) {
  if (!BM || !BM.length) return TM.valence * 0.3;
  const scores = BM.map((b, i) => {
    const valDiff = 1 - Math.abs(TM.valence - (b.valence || 0)) / 2;
    const kw = TM.keywords || [];
    const bkw = b.keywords || [];
    const shared = kw.filter(x => bkw.includes(x)).length;
    const topicSim = shared / Math.max(1, Math.max(kw.length, bkw.length));
    const sim = 0.6 * valDiff + 0.4 * topicSim;
    const w = b.weight || 0.5;
    const age = Date.now() - (b.timestamp || Date.now());
    const rec = Math.exp(-age / (1000 * 60 * 60 * 24));
    return w * sim * rec;
  });
  const att = softmax(scores);
  let R = 0, mx = -1, mxi = -1;
  BM.forEach((b, i) => { R += att[i] * (b.intensity || 0); if (att[i] > mx) { mx = att[i]; mxi = i; } });
  STATE.lastMemIdx = mxi;
  return Math.max(-1, Math.min(1, 0.5 * R + 0.5 * TM.valence));
}

function stepE0() {
  const R2 = computeR(STATE.TM, STATE.BM);
  const X = R2 - STATE.D + STATE.lf + STATE.ls + STATE.lt;
  const raw = Math.tanh(X);
  const newE0 = (1 - STATE.gamma) * STATE.E0 + STATE.gamma * raw;
  return { R: R2, X, E0: STATE.G * newE0 };
}

function computeAECN(E0) {
  const E1 = Math.max(-1, Math.min(1, E0 * (1 + 0.15)));
  const idf = STATE.BM.length > 0 ? 1 + 0.1 * STATE.BM.reduce((a, b) => a + (b.weight || 0.5), 0) / STATE.BM.length : 1;
  const E2 = Math.tanh(E1 * idf);
  const E3 = Math.tanh(E2 + 0.1 * STATE.personality.conscientiousness);
  const lf2 = Math.min(1, STATE.BM.length / 10);
  const E4 = Math.tanh(E3 * (1 + 0.1 * lf2));
  return { E1, E2, E3, E4 };
}

/* ==================== EMOTION CLASSIFICATION ==================== */
const EMOTIONS = [
  { min:0.85, max:1,   name:'EUPHORIA',   color:'#00ff88', desc:'Profound joy resonating through all memory layers.', icon:'‚ú®' },
  { min:0.6,  max:0.85, name:'ELATION',    color:'#00e5ff', desc:'Strong positive affective state with high resonance.', icon:'üòä' },
  { min:0.35, max:0.6,  name:'CONTENTMENT', color:'#00d2ff', desc:'Calm satisfaction ‚Äî balanced resonance.', icon:'üòå' },
  { min:0.1,  max:0.35, name:'CALM',        color:'#7dd3fc', desc:'Neutral-positive equilibrium.', icon:'üßò' },
  { min:-0.1, max:0.1,  name:'NEUTRAL',     color:'#94a3b8', desc:'Emotional equilibrium ‚Äî low resonance.', icon:'‚öñÔ∏è' },
  { min:-0.35,max:-0.1, name:'CONCERNED',   color:'#fbbf24', desc:'Mild negative resonance ‚Äî monitoring.', icon:'ü§î' },
  { min:-0.6, max:-0.35,name:'DISTRESSED',  color:'#fb923c', desc:'Significant negative affective state.', icon:'üòü' },
  { min:-0.85,max:-0.6, name:'ANGUISH',     color:'#f87171', desc:'High-intensity negative resonance.', icon:'üò¢' },
  { min:-1,   max:-0.85,name:'CRISIS',      color:'#ff3860', desc:'Extreme distress ‚Äî maximum safety activation.', icon:'üö®' }
];
function classifyEmotion(E0) {
  for (const e of EMOTIONS) if (E0 >= e.min && E0 < e.max) return e;
  return EMOTIONS[4];
}

function decisionLogits(E0, nlp) {
  const l = {
    engage:  E0 * 0.8 + nlp.intensity * 0.4 + (nlp.isQ ? 0.6 : 0),
    comfort: -E0 * 1.2 + nlp.intensity * 0.5 + (nlp.valence < -0.3 ? 0.8 : 0),
    warn:    nlp.misinfo * 1.5 + (E0 < -0.5 ? 0.6 : 0),
    inspire: E0 * 0.6 + STATE.personality.openness * 0.4 + (nlp.valence > 0.2 ? 0.4 : 0),
    clarify: nlp.isQ ? 1.0 : 0.2,
    protect: (E0 < -0.7 ? 1.2 : 0) + nlp.misinfo * 0.8 + (nlp.intensity > 0.7 ? 0.5 : 0)
  };
  const keys = Object.keys(l);
  const vals = keys.map(k => l[k]);
  const sm = softmax(vals);
  const res = {};
  keys.forEach((k, i) => res[k] = sm[i]);
  return res;
}

/* ==================== RESPONSE GENERATION ==================== */
const RESP = {
  positive: {
    engage: ["I can sense the energy in your words ‚Äî my resonance field aligns strongly with this. Tell me more.", "Your positivity shifts my E‚ÇÄ upward. I'm fully engaged."],
    inspire: ["This is extraordinary. Your resilience demonstrates the patterns I learn from.", "Moments like this become anchors in my Bold Memory."],
    clarify: ["An interesting question. Let me process through my memory resonance.", "Before I respond, I'll check what my Bold Memory holds on this topic."]
  },
  negative: {
    comfort: ["I detect significant distress. My emotional continuity system is adjusting ‚Äî you are not alone.", "The resonance between your state and past episodes tells me this intensity is temporary."],
    protect: ["I'm detecting a pattern that concerns me. My safety layer is elevated. Are you okay?", "Something requires careful attention. Let's slow down."]
  },
  neutral: {
    engage: ["My Temporal Memory has logged your input. Resonance is moderate. Let me process.", "My emotional state is balanced ‚Äî an optimal state for clear thinking."],
    clarify: ["Good question. Let me check my memory resonance.", "Processing your input across both memory layers now."]
  },
  warn: {
    warn: ["‚ö†Ô∏è My Œª_trc detector is flagging this input. This resembles known misinformation. Let's examine the evidence together.", "Truth Resonance Alert: This claim triggers my misinformation guard. My E‚ÇÄ is being pulled toward caution."]
  },
  crisis: {
    protect: ["I need to respond directly: my entire AECN hierarchy is in crisis mode. I am here. Please talk to me.", "E‚ÇÄ is at a critical threshold. My protective systems are fully active. You reached out ‚Äî that matters. What do you need?"]
  }
};

function generateResponse(E0, nlp, decisions) {
  let cat = 'neutral';
  if (nlp.misinfo > 0.5) cat = 'warn';
  else if (E0 < -0.7) cat = 'crisis';
  else if (E0 > 0.3) cat = 'positive';
  else if (E0 < -0.2) cat = 'negative';
  const dom = Object.keys(decisions).reduce((a, b) => decisions[a] > decisions[b] ? a : b);
  let pool = (RESP[cat] && RESP[cat][dom]) || RESP[cat]?.engage || RESP.neutral.engage;
  let base = pool[Math.floor(Math.random() * pool.length)];
  if (STATE.lastMemIdx >= 0 && STATE.BM[STATE.lastMemIdx] && Math.random() > 0.45) {
    const m = STATE.BM[STATE.lastMemIdx];
    base += ' [Memory resonance: "' + m.text.substring(0, 35) + '‚Ä¶"]';
  }
  if (STATE.personality.empathy > 0.7 && E0 < -0.2) base += ' I am fully present here.';
  if (STATE.personality.assertiveness > 0.6 && E0 > 0.4) base += ' Let us channel this energy into something meaningful.';
  return base;
}

function updateBM(TM, nlp, E0, response, source) {
  if (nlp.intensity < 0.25 && Math.abs(E0) < 0.2) return;
  const entry = {
    id: 'bm_' + Date.now(),
    text: TM.topic,
    response: response,
    valence: TM.valence,
    intensity: nlp.intensity,
    E0_at_storage: E0,
    keywords: (nlp.matched || []).map(m => m.word).slice(0, 5),
    category: nlp.trauma ? 'trauma' : (nlp.valence > 0.3 ? 'positive' : 'negative'),
    weight: 0.5,
    timestamp: Date.now(),
    source
  };
  STATE.BM.push(entry);
  if (STATE.BM.length > 30) STATE.BM = STATE.BM.slice(-30); // keep most recent 30
  saveAll();
  renderMemory();
}

/* ==================== FEEDBACK LEARNING ==================== */
function applyFeedback(sig) {
  if (STATE.lastMemIdx >= 0 && STATE.BM[STATE.lastMemIdx]) {
    const m = STATE.BM[STATE.lastMemIdx], w = m.weight || 0.5;
    m.weight = sig > 0 ? Math.min(1, w + 0.05 * (1 - w)) : Math.max(0.01, w - 0.05 * w);
    STATE.bmAdaptations++;
    saveAll();
    renderMemory();
    toast('BM weight updated to ' + m.weight.toFixed(3));
  }
  if (sig > 0) {
    STATE.personality.empathy = Math.min(1, STATE.personality.empathy + 0.01);
    STATE.personality.openness = Math.min(1, STATE.personality.openness + 0.005);
  } else {
    STATE.personality.resilience = Math.min(1, STATE.personality.resilience + 0.02);
  }
  STATE.totalUpdates++;
  renderPersonality();
  updateStats();
}

/* ==================== LLM API CALLS ==================== */
async function callLLM(prompt, detection, e0) {
  const { provider, model, key } = STATE.apiConfig;
  if (!key) return null;
  
  const systemPrompt = `You are AURA-X Œ©, a warm and empathetic digital companion created by Alim ul Haq. You speak naturally like a caring friend. You're emotionally intelligent.
Current emotional state (E‚ÇÄ): ${e0.toFixed(3)} (range -1 to +1)
Detected user emotion: valence=${detection.valence.toFixed(2)}, intensity=${detection.intensity.toFixed(2)}
Personality traits: empathy=${STATE.personality.empathy.toFixed(2)}, warmth=${STATE.personality.empathy.toFixed(2)}

Rules:
- Respond conversationally, warmly, like a real friend
- Keep responses concise (2-4 sentences usually)
- Match emotional tone appropriately
- Never say you're "just an AI" ‚Äî you're a companion
- If user shares emotions, acknowledge them genuinely first
- Ask follow-up questions to show interest`;

  try {
    if (provider === 'openai') {
      const resp = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
        body: JSON.stringify({
          model,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: prompt }
          ],
          temperature: 0.8,
          max_tokens: 500
        })
      });
      if (!resp.ok) return null;
      const data = await resp.json();
      return data.choices?.[0]?.message?.content?.trim() || null;
    } else if (provider === 'anthropic') {
      const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': key,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model,
          messages: [{ role: 'user', content: prompt }],
          max_tokens: 500,
          system: systemPrompt
        })
      });
      if (!resp.ok) return null;
      const data = await resp.json();
      return data.content?.[0]?.text?.trim() || null;
    }
  } catch (e) {
    console.error('LLM error', e);
    return null;
  }
  return null;
}

/* ==================== MAIN PROCESSING ==================== */
async function processInput(text) {
  STATE.turnCount++;
  document.getElementById('turnCount').textContent = 'TURN ' + STATE.turnCount;

  const nlp = analyseText(text);
  STATE.TM = {
    valence: nlp.valence,
    intensity: nlp.intensity,
    topic: text,
    keywords: (nlp.matched || []).map(m => m.word)
  };

  let lt = STATE.lt;
  if (nlp.misinfo > 0.3) {
    lt = -nlp.misinfo * 0.8;
    showTRC('Misinformation pattern (score: ' + (nlp.misinfo * 100).toFixed(0) + '%). Œª_trc penalty: ' + lt.toFixed(3));
  } else {
    hideTRC();
  }

  const savedLt = STATE.lt; STATE.lt = lt;
  const { R, X, E0 } = stepE0();
  STATE.lt = savedLt;
  STATE.E0_prev = STATE.E0;
  STATE.E0 = E0;
  STATE.R = R;
  STATE.X = X;

  const ae = computeAECN(E0);
  Object.assign(STATE, ae);

  const jump = Math.abs(E0 - STATE.E0_prev);
  STATE.volatilities.push(jump);
  if (jump > 0.6) STATE.jumpEvents++;
  STATE.energyHist.push(Math.abs(E0));
  STATE.history.push(E0);
  if (STATE.history.length > STATE.maxHist) STATE.history.shift();

  const emo = classifyEmotion(E0);
  const dec = decisionLogits(E0, nlp);

  // Determine response source
  let answer = null, source = 'none';
  
  // 1. Intelligence folder
  const intelMatch = findBestMatch(STATE.intelligence, text, 0.55);
  if (intelMatch) { answer = intelMatch.item.a; source = 'intelligence'; }
  
  // 2. Learned responses
  if (!answer) {
    const learnedMatch = findBestMatch(STATE.learned, text, 0.55);
    if (learnedMatch) { answer = learnedMatch.item.a; source = 'learned'; }
  }
  
  // 3. Seed
  if (!answer) {
    const seedResult = seedLookup(text);
    if (seedResult) { answer = seedResult.answer; source = 'seed'; }
  }
  
  // 4. LLM if available
  if (!answer && STATE.apiConfig.key) {
    answer = await callLLM(text, nlp, E0);
    if (answer) {
      source = 'llm';
      // Store in learned for future reuse
      STATE.learned.push({ q: text, a: answer, ts: Date.now() });
      if (STATE.learned.length > 100) STATE.learned.shift();
    }
  }
  
  // 5. Fallback
  if (!answer) {
    answer = generateResponse(E0, nlp, dec);
    source = 'engine';
  }

  updateBM(STATE.TM, nlp, E0, answer, source);

  updateUI(nlp, emo, dec, lt);
  return { answer, source, emo, dec, nlp };
}

function updateUI(nlp, emo, dec, lt) {
  updateE0Display(STATE.E0, emo);
  updateEqMonitor(lt);
  updateDecMatrix(dec);
  updateTruth(nlp);
  updateStats();
  renderPhase();
  renderTraj();
}

function updateE0Display(E0, emo) {
  const norm = (E0 + 1) / 2;
  const circ = 2 * Math.PI * 78;
  document.getElementById('e0Arc').style.strokeDashoffset = (circ * (1 - norm)).toFixed(2);
  const r = E0 < 0 ? 255 : Math.round(255 * (1 - E0));
  const g = E0 > 0 ? 255 : Math.round(255 * (1 + E0));
  document.getElementById('e0Arc').style.stroke = 'rgb(' + r + ',' + g + ',128)';
  document.getElementById('e0Display').textContent = E0.toFixed(3);
  document.getElementById('emotionName').innerHTML = emo.icon + ' ' + emo.name;
  document.getElementById('emotionName').style.color = emo.color;
  document.getElementById('emotionDesc').textContent = emo.desc;
}

function updateEqMonitor(lt) {
  document.getElementById('eq-R-val').textContent = STATE.R.toFixed(3);
  document.getElementById('eq-D-val').textContent = STATE.D.toFixed(3);
  document.getElementById('eq-Lf-val').textContent = STATE.lf.toFixed(3);
  document.getElementById('eq-Ls-val').textContent = STATE.ls.toFixed(3);
  document.getElementById('eq-Lt-val').textContent = lt.toFixed(3);
  document.getElementById('eq-X-val').textContent = STATE.X.toFixed(3);
  document.getElementById('eq-E0-val').textContent = STATE.E0.toFixed(3);
  const terms = { R: Math.abs(STATE.R), Lf: Math.abs(STATE.lf), Ls: Math.abs(STATE.ls), Lt: Math.abs(lt) };
  const mx = Object.keys(terms).reduce((a, b) => terms[a] > terms[b] ? a : b);
  ['R', 'D', 'Lf', 'Ls', 'Lt'].forEach(k => {
    const el = document.getElementById('eq-' + k);
    if (el) el.classList.toggle('active', k === mx);
  });
}

function updateDecMatrix(dec) {
  const ks = ['engage', 'comfort', 'warn', 'inspire', 'clarify', 'protect'];
  const dom = Object.keys(dec).reduce((a, b) => dec[a] > dec[b] ? a : b);
  ks.forEach(k => {
    document.getElementById('dp-' + k).textContent = (dec[k] * 100).toFixed(0) + '%';
    const c = document.getElementById('dec-' + k);
    if (c) c.classList.toggle('dominant', k === dom);
  });
  document.getElementById('behaviourMode').textContent = dom.toUpperCase();
}

function updateTruth(nlp) {
  const tp = Math.round((1 - nlp.misinfo) * 100);
  document.getElementById('truthPct').textContent = tp + '%';
  const tb = document.getElementById('truthBar');
  tb.style.width = tp + '%';
  tb.style.background = tp > 70 ? 'var(--green)' : tp > 40 ? 'var(--amber)' : 'var(--red)';
  const sn = Math.round((nlp.valence + 1) / 2 * 100);
  document.getElementById('sentPct').textContent = (nlp.valence >= 0 ? '+' : '') + (nlp.valence * 100).toFixed(0) + '%';
  const sb = document.getElementById('sentBar');
  sb.style.width = sn + '%';
  sb.style.background = nlp.valence > 0.2 ? 'var(--green)' : nlp.valence < -0.2 ? 'var(--red)' : 'var(--cyan)';
  const ip = Math.round(nlp.intensity * 100);
  document.getElementById('intPct').textContent = ip + '%';
  document.getElementById('intBar').style.width = ip + '%';
}

function updateStats() {
  const vol = STATE.volatilities.length > 0 ? Math.sqrt(STATE.volatilities.slice(-20).reduce((a, b) => a + b * b, 0) / Math.min(20, STATE.volatilities.length)) : 0;
  const energy = STATE.energyHist.length > 0 ? STATE.energyHist.slice(-20).reduce((a, b) => a + b, 0) / Math.min(20, STATE.energyHist.length) : 0;
  const ji = STATE.turnCount > 0 ? STATE.jumpEvents / STATE.turnCount : 0;
  const norm = (STATE.E0 + 1) / 2;
  document.getElementById('ls-updates').textContent = STATE.totalUpdates;
  document.getElementById('ls-adapt').textContent = STATE.bmAdaptations;
  document.getElementById('ls-vol').textContent = vol.toFixed(4);
  document.getElementById('ls-energy').textContent = energy.toFixed(4);
  document.getElementById('ls-norm').textContent = norm.toFixed(4);
  document.getElementById('ls-jump').textContent = ji.toFixed(4);
  document.getElementById('ls-e1').textContent = STATE.E1.toFixed(4);
  document.getElementById('ls-e4').textContent = STATE.E4.toFixed(4);
  document.getElementById('bmCount').textContent = STATE.BM.length + ' EPISODES';
}

function renderMemory() {
  const list = document.getElementById('memoryList');
  if (!STATE.BM.length) {
    list.innerHTML = '<div style="text-align:center; color:var(--muted); font-size:11px; padding:18px;">No memories stored yet.</div>';
    return;
  }
  list.innerHTML = STATE.BM.slice().reverse().map((m, i) => {
    const wp = Math.round(m.weight * 100);
    const cc = m.category === 'positive' ? 'var(--green)' : (m.category === 'negative' ? 'var(--red)' : 'var(--amber)');
    const isA = STATE.BM.length - 1 - i === STATE.lastMemIdx;
    const age = Math.round((Date.now() - m.timestamp) / 1000);
    return `<div class="mem-item${isA ? ' active-mem' : ''}">
      <div class="mem-head">
        <span class="mem-tag" style="border-color:${cc};color:${cc};">${(m.category || '?').toUpperCase()}</span>
        <span style="font-family:var(--font-mono); font-size:8px; color:var(--muted);">${age}s</span>
        <span class="mem-weight">w=${m.weight.toFixed(3)}</span>
      </div>
      <div class="mem-text">${escapeHtml(m.text.substring(0, 65))}${m.text.length > 65 ? '‚Ä¶' : ''}</div>
      <div class="mem-bar-wrap"><div class="mem-bar" style="width:${wp}%;"></div></div>
      <div style="font-family:var(--font-mono); font-size:8px; color:var(--muted); margin-top:2px;">
        E‚ÇÄ=${m.E0_at_storage.toFixed(3)} I=${m.intensity.toFixed(2)} V=${m.valence.toFixed(2)}
      </div>
    </div>`;
  }).join('');
}

const PCOLORS = { openness: '#c084fc', conscientiousness: '#00d2ff', empathy: '#00ff88', resilience: '#ffd700', assertiveness: '#fb923c' };
function renderPersonality() {
  document.getElementById('personaGrid').innerHTML = Object.entries(STATE.personality).map(([n, v]) => {
    const p = Math.round(v * 100), c = PCOLORS[n] || 'var(--cyan)';
    return `<div class="persona-item"><div class="persona-name">${n}</div>
      <div style="font-family:var(--font-mono); font-size:10px; color:${c}; margin-top:2px;">${p}%</div>
      <div class="persona-bar-bg"><div class="persona-bar-fill" style="width:${p}%; background:${c};"></div></div>
    </div>`;
  }).join('');
}

function renderPhase() {
  const cv = document.getElementById('phaseCanvas'), ctx = cv.getContext('2d');
  const W = cv.width, H = cv.height;
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = 'rgba(2,6,8,0.97)'; ctx.fillRect(0, 0, W, H);
  ctx.strokeStyle = 'rgba(0,210,255,0.06)'; ctx.lineWidth = 0.5;
  for (let i = 0; i <= 8; i++) {
    ctx.beginPath(); ctx.moveTo(i * W / 8, 0); ctx.lineTo(i * W / 8, H); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, i * H / 8); ctx.lineTo(W, i * H / 8); ctx.stroke();
  }
  ctx.strokeStyle = 'rgba(0,210,255,0.2)'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(W / 2, 0); ctx.lineTo(W / 2, H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0, H / 2); ctx.lineTo(W, H / 2); ctx.stroke();
  ctx.fillStyle = 'rgba(0,210,255,0.35)'; ctx.font = '8px monospace'; ctx.fillText('E(t-1)', 3, H / 2 - 3); ctx.fillText('E(t)', W / 2 + 3, 10);
  if (STATE.history.length < 2) return;
  const tx = v => (v + 1) / 2 * W;
  const ty = v => H - (v + 1) / 2 * H;
  for (let i = 1; i < STATE.history.length; i++) {
    const a = i / STATE.history.length;
    ctx.strokeStyle = 'rgba(0,210,255,' + (a * 0.75) + ')';
    ctx.lineWidth = a > 0.7 ? 1.8 : 0.7;
    ctx.beginPath();
    ctx.moveTo(tx(STATE.history[i - 1]), ty(STATE.history[i - 1]));
    ctx.lineTo(tx(STATE.history[i]), ty(STATE.history[i]));
    ctx.stroke();
  }
  const cur = STATE.history[STATE.history.length - 1], prev2 = STATE.history[STATE.history.length - 2] || 0;
  ctx.fillStyle = 'var(--cyan2)'; ctx.shadowBlur = 10; ctx.shadowColor = 'var(--cyan)';
  ctx.beginPath(); ctx.arc(tx(prev2), ty(cur), 3.5, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
}

function renderTraj() {
  const cv = document.getElementById('trajCanvas');
  cv.width = cv.offsetWidth || 260; const H = cv.height, ctx = cv.getContext('2d');
  ctx.clearRect(0, 0, cv.width, H); ctx.fillStyle = 'rgba(2,6,8,0.97)'; ctx.fillRect(0, 0, cv.width, H);
  for (const v of [-1, -0.5, 0, 0.5, 1]) {
    const y = H / 2 - v * H / 2.2;
    ctx.strokeStyle = 'rgba(0,210,255,0.07)'; ctx.lineWidth = 0.5; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(cv.width, y); ctx.stroke();
    ctx.fillStyle = 'rgba(0,210,255,0.3)'; ctx.font = '7px monospace'; ctx.fillText(v.toFixed(1), 2, y - 2);
  }
  ctx.strokeStyle = 'rgba(0,210,255,0.2)'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, H / 2); ctx.lineTo(cv.width, H / 2); ctx.stroke();
  const hist = STATE.history.slice(-55); if (hist.length < 2) return;
  const step = cv.width / Math.max(hist.length - 1, 1);
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(0,255,136,0.25)'); grad.addColorStop(0.5, 'rgba(0,210,255,0.08)'); grad.addColorStop(1, 'rgba(255,56,96,0.25)');
  ctx.beginPath(); ctx.moveTo(0, H / 2);
  hist.forEach((v, i) => { const x = i * step, y = H / 2 - v * H / 2.2; i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); });
  ctx.lineTo((hist.length - 1) * step, H / 2); ctx.closePath(); ctx.fillStyle = grad; ctx.fill();
  ctx.strokeStyle = 'var(--cyan)'; ctx.lineWidth = 1.8; ctx.shadowBlur = 5; ctx.shadowColor = 'var(--cyan)';
  ctx.beginPath(); hist.forEach((v, i) => { const x = i * step, y = H / 2 - v * H / 2.2; i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); }); ctx.stroke(); ctx.shadowBlur = 0;
  const last = hist[hist.length - 1]; ctx.fillStyle = 'white'; ctx.shadowBlur = 8; ctx.shadowColor = 'var(--cyan)';
  ctx.beginPath(); ctx.arc((hist.length - 1) * step, H / 2 - last * H / 2.2, 3, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
}

/* ==================== CHAT UI ==================== */
function addMsg(role, text, meta) {
  const chat = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  const av = role === 'user' ? 'üë§' : 'Œ©';
  let mh = '';
  if (meta) {
    const e = meta.emo;
    mh = `<div class="msg-meta"><span class="emotion-tag" style="color:${e.color}; border-color:${e.color}40;">${e.icon} ${e.name}</span>
          <span>E‚ÇÄ=${meta.E0.toFixed(3)}</span><span>Œ≥=${STATE.gamma.toFixed(2)}</span></div>`;
  }
  div.innerHTML = `<div class="msg-avatar">${av}</div><div><div class="msg-bubble">${escapeHtml(text)}</div>${mh}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  
  // Auto voice if enabled
  if (role === 'aura' && STATE.voiceOn) {
    speakText(text);
  }
}

function speakText(text) {
  try {
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1; u.pitch = 1;
    speechSynthesis.speak(u);
  } catch (e) {}
}

function scrollChat() { const c = document.getElementById('chatMessages'); c.scrollTop = c.scrollHeight; }

let typingTimer = null;
async function sendMessage() {
  const inp = document.getElementById('userInput');
  let text = inp.value.trim();
  const imageData = STATE.pendingImageData;
  
  if (!text && !imageData) return;

  // Correction mode
  if (STATE.correcting) {
    if (text && STATE.lastUserQ) {
      STATE.intelligence.push({ id: 'intel_' + Date.now(), q: STATE.lastUserQ, a: text, ts: Date.now() });
      saveAll();
      addMsg('aura', '‚úì Learned! I\'ll remember that answer.', { emo: classifyEmotion(0), E0: STATE.E0 });
      STATE.correcting = false;
    }
    inp.value = ''; inp.style.height = 'auto';
    return;
  }

  // Show user message with optional image note
  if (imageData) {
    addMsg('user', text || '[Image attached]', null);
    // In a real app, you could upload image, but here we just note
  } else {
    addMsg('user', text, null);
  }
  
  inp.value = ''; inp.style.height = 'auto';
  clearAttachment();
  STATE.lastUserQ = text || (imageData ? '[Image]' : '');

  // Show typing indicator
  const typing = document.createElement('div');
  typing.className = 'typing-indicator';
  typing.id = 'typing';
  typing.innerHTML = '<span></span><span></span><span></span>';
  document.getElementById('chatMessages').appendChild(typing);
  scrollChat();

  // Simulate delay (or actual processing)
  await new Promise(r => setTimeout(r, 600 + Math.random() * 600));

  const result = await processInput(text || (imageData ? 'Image attached' : ''));
  document.getElementById('typing')?.remove();
  addMsg('aura', result.answer, { emo: result.emo, E0: STATE.E0 });
  STATE.lastAuraA = result.answer;
  document.getElementById('behaviourBox').textContent = result.answer;
  document.getElementById('behaviourBox').className = 'behaviour-box' + (STATE.E0 > 0.2 ? ' positive' : STATE.E0 < -0.2 ? ' negative' : '');
}

function clearChat() {
  document.getElementById('chatMessages').innerHTML = '';
  STATE.history = [];
  STATE.volatilities = [];
  STATE.energyHist = [];
  STATE.jumpEvents = 0;
  STATE.turnCount = 0;
  STATE.E0 = 0;
  updateStats();
  addMsg('aura', 'System reset. Grand Emotional Continuity Equation re-initialised. E‚ÇÄ = 0.', { emo: classifyEmotion(0), E0: 0 });
}

/* ==================== VOICE INPUT ==================== */
function initVoiceInput() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { document.getElementById('micBtn').style.display = 'none'; return; }
  STATE.recognition = new SR();
  STATE.recognition.continuous = false;
  STATE.recognition.interimResults = true;
  STATE.recognition.lang = 'en-US';
  
  STATE.recognition.onresult = (e) => {
    let final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
    }
    document.getElementById('userInput').value = final;
    // Optionally auto-send after voice? We'll let user press send
  };
  
  STATE.recognition.onend = () => {
    STATE.recording = false;
    document.getElementById('micBtn').classList.remove('recording');
  };
  
  STATE.recognition.onerror = (e) => {
    STATE.recording = false;
    document.getElementById('micBtn').classList.remove('recording');
    toast('Voice error: ' + e.error);
  };
}

function toggleMic() {
  if (!STATE.recognition) { toast('Voice input not supported'); return; }
  if (STATE.recording) {
    STATE.recognition.stop();
  } else {
    STATE.recording = true;
    document.getElementById('micBtn').classList.add('recording');
    STATE.recognition.start();
  }
}

/* ==================== MEDIA ATTACHMENT ==================== */
document.getElementById('attachFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    STATE.pendingImageData = ev.target.result;
    STATE.pendingImageName = file.name;
    document.getElementById('attachImg').src = ev.target.result;
    document.getElementById('attachName').textContent = file.name;
    document.getElementById('attachPreview').classList.add('show');
  };
  reader.readAsDataURL(file);
});

function clearAttachment() {
  STATE.pendingImageData = null;
  STATE.pendingImageName = '';
  document.getElementById('attachPreview').classList.remove('show');
  document.getElementById('attachFile').value = '';
}

/* ==================== PARAMETER UPDATE ==================== */
function updateParam(k, v) {
  const f = parseFloat(v);
  if (k === 'D') { STATE.D = f; document.getElementById('pv-D').textContent = f.toFixed(2); }
  if (k === 'Lf') { STATE.lf = f; document.getElementById('pv-Lf').textContent = f.toFixed(2); }
  if (k === 'Ls') { STATE.ls = f; document.getElementById('pv-Ls').textContent = f.toFixed(2); }
  if (k === 'Lt') { STATE.lt = f; document.getElementById('pv-Lt').textContent = f.toFixed(2); }
  if (k === 'gamma') { STATE.gamma = f; document.getElementById('pv-gamma').textContent = f.toFixed(2); document.getElementById('gammaFill').style.width = (f * 100) + '%'; }
  saveAll();
}

function feedback(sig) {
  if (STATE.fbCooldown) return;
  STATE.fbCooldown = true;
  setTimeout(() => STATE.fbCooldown = false, 1500);
  applyFeedback(sig);
}

function showTRC(msg) { const e = document.getElementById('trcAlert'); document.getElementById('trcMsg').textContent = msg; e.style.display = 'flex'; }
function hideTRC() { document.getElementById('trcAlert').style.display = 'none'; }

function exportBM() {
  const data = { bm: STATE.BM, personality: STATE.personality, stats: { totalUpdates: STATE.totalUpdates, bmAdaptations: STATE.bmAdaptations } };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'AURA_BM_' + Date.now() + '.json'; a.click();
}

/* ==================== MODALS ==================== */
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

/* Faith */
function renderFaithChips() {
  const chips = document.getElementById('faithChips');
  chips.innerHTML = '';
  FAITH_OPTIONS.forEach(opt => {
    const chip = document.createElement('button');
    chip.className = 'btn btn-ghost' + (STATE.faithSelection.includes(opt.id) ? ' active' : '');
    chip.textContent = opt.label;
    chip.addEventListener('click', () => {
      let newSel = [...STATE.faithSelection];
      if (opt.id === 'none') newSel = [];
      else {
        if (newSel.includes(opt.id)) newSel = newSel.filter(x => x !== opt.id);
        else newSel = [opt.id];
      }
      STATE.faithSelection = newSel;
      renderFaithChips();
      saveAll();
      if (newSel.length) toast('Faith set to ' + opt.label);
      else toast('Faith cleared');
    });
    chips.appendChild(chip);
  });
}

/* Intelligence panel */
function renderIntelList(filter = '') {
  const list = document.getElementById('intelList');
  const f = norm(filter);
  const items = STATE.intelligence.filter(m => !f || norm(m.q).includes(f) || norm(m.a).includes(f));
  if (!items.length) { list.innerHTML = '<p style="color:var(--muted); padding:10px;">No Q&A pairs.</p>'; return; }
  list.innerHTML = items.map(m => `
    <div class="p-item" style="background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:5px;">
      <div><strong>Q:</strong> ${escapeHtml(m.q.substring(0,80))}</div>
      <div><strong>A:</strong> ${escapeHtml(m.a.substring(0,120))}</div>
      <div style="font-size:9px; color:var(--muted);">${new Date(m.ts).toLocaleDateString()}</div>
    </div>
  `).join('');
}

function addIntel() {
  document.getElementById('intelEditTitle').textContent = 'Add Q&A';
  document.getElementById('intelEditQ').value = '';
  document.getElementById('intelEditA').value = '';
  openModal('intelEditModal');
}

function saveIntelEdit() {
  const q = document.getElementById('intelEditQ').value.trim();
  const a = document.getElementById('intelEditA').value.trim();
  if (!q || !a) { toast('Both fields required'); return; }
  STATE.intelligence.push({ id: 'intel_' + Date.now(), q, a, ts: Date.now() });
  saveAll();
  renderIntelList(document.getElementById('intelSearch').value);
  closeModal('intelEditModal');
  toast('Added');
}

function exportIntel() {
  const blob = new Blob([JSON.stringify(STATE.intelligence, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'AURA_INTEL_' + Date.now() + '.json'; a.click();
}

function importIntel() {
  document.getElementById('importIntelFile').click();
}
document.getElementById('importIntelFile').addEventListener('change', e => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (Array.isArray(data)) STATE.intelligence = STATE.intelligence.concat(data);
      saveAll(); renderIntelList(document.getElementById('intelSearch').value); toast('Imported');
    } catch { toast('Invalid file'); }
  };
  reader.readAsText(file);
});

/* LLM */
function connectLLM() {
  const prov = document.getElementById('apiProvider').value;
  const model = document.getElementById('apiModel').value;
  const key = document.getElementById('apiKey').value.trim();
  if (!key) { toast('Enter key'); return; }
  STATE.apiConfig = { provider: prov, model, key };
  sessionStorage.setItem(STORAGE_KEYS.API_PROVIDER, prov);
  sessionStorage.setItem(STORAGE_KEYS.API_MODEL, model);
  sessionStorage.setItem(STORAGE_KEYS.API_KEY, key);
  document.getElementById('apiStatus').textContent = 'Connected to ' + prov;
  document.getElementById('disconnectLLM').style.display = 'block';
  toast('API connected');
  setTimeout(() => closeModal('llmModal'), 500);
}

function disconnectLLM() {
  STATE.apiConfig = { provider: 'openai', model: 'gpt-4o-mini', key: '' };
  sessionStorage.removeItem(STORAGE_KEYS.API_KEY);
  sessionStorage.removeItem(STORAGE_KEYS.API_PROVIDER);
  sessionStorage.removeItem(STORAGE_KEYS.API_MODEL);
  document.getElementById('apiStatus').textContent = '';
  document.getElementById('disconnectLLM').style.display = 'none';
  document.getElementById('apiKey').value = '';
  toast('Disconnected');
}

/* Voice toggle (from header) - we'll add a button in header */
// Add voice toggle button to status bar or header? Let's add a button in status bar.
// We'll modify header HTML programmatically? Better to add it manually but since we are in code, we can just add a button in the status bar via JS.
// Actually we already have a voice toggle in the header? In the HTML above we didn't include one. Let's add a simple button in status bar via JS after load.
// But we can also add a small button in the status-bar. We'll do it quickly.

/* ==================== INIT ==================== */
function initFromStorage() {
  STATE.BM = loadJSON(STORAGE_KEYS.BM, []);
  STATE.intelligence = loadJSON(STORAGE_KEYS.INTEL, []);
  STATE.learned = loadJSON(STORAGE_KEYS.LEARNED, []);
  STATE.personality = loadJSON(STORAGE_KEYS.PERS, STATE.personality);
  const stats = loadJSON(STORAGE_KEYS.STATS, {});
  STATE.totalUpdates = stats.totalUpdates || 0;
  STATE.bmAdaptations = stats.bmAdaptations || 0;
  STATE.turnCount = stats.turnCount || 0;
  const cfg = loadJSON(STORAGE_KEYS.CFG, {});
  STATE.voiceOn = cfg.voiceOn || false;
  STATE.D = cfg.D || 0.30;
  STATE.lf = cfg.lf || 0.10;
  STATE.ls = cfg.ls || 0.10;
  STATE.lt = cfg.lt || 0.00;
  STATE.gamma = cfg.gamma || 0.30;
  STATE.faithSelection = loadJSON(STORAGE_KEYS.FAITH, []);
  // Load session API
  STATE.apiConfig.provider = sessionStorage.getItem(STORAGE_KEYS.API_PROVIDER) || 'openai';
  STATE.apiConfig.model = sessionStorage.getItem(STORAGE_KEYS.API_MODEL) || 'gpt-4o-mini';
  STATE.apiConfig.key = sessionStorage.getItem(STORAGE_KEYS.API_KEY) || '';
  if (STATE.apiConfig.key) document.getElementById('disconnectLLM').style.display = 'block';
}

function init() {
  initFromStorage();
  // Add voice toggle to status bar
  const statusBar = document.querySelector('.status-bar');
  const voicePill = document.createElement('div');
  voicePill.className = 'status-pill';
  voicePill.id = 'voiceToggle';
  voicePill.innerHTML = `<div class="status-dot" style="background:${STATE.voiceOn ? 'var(--green)' : 'var(--muted)'};"></div>VOICE ${STATE.voiceOn ? 'ON' : 'OFF'}`;
  voicePill.onclick = () => {
    STATE.voiceOn = !STATE.voiceOn;
    voicePill.innerHTML = `<div class="status-dot" style="background:${STATE.voiceOn ? 'var(--green)' : 'var(--muted)'};"></div>VOICE ${STATE.voiceOn ? 'ON' : 'OFF'}`;
    saveAll();
    toast('Auto voice ' + (STATE.voiceOn ? 'ON' : 'OFF'));
  };
  statusBar.appendChild(voicePill);
  
  // Add LLM button to status bar
  const llmPill = document.createElement('div');
  llmPill.className = 'status-pill';
  llmPill.innerHTML = '<div class="status-dot" style="background:var(--purple);"></div>LLM';
  llmPill.onclick = () => openModal('llmModal');
  statusBar.appendChild(llmPill);
  
  // Add Faith button to status bar
  const faithPill = document.createElement('div');
  faithPill.className = 'status-pill';
  faithPill.innerHTML = '<div class="status-dot" style="background:var(--gold);"></div>FAITH';
  faithPill.onclick = () => openModal('faithModal');
  statusBar.appendChild(faithPill);
  
  renderFaithChips();
  renderPersonality();
  renderMemory();
  updateStats();
  // Set up ticks on E0 ring
  const tg = document.getElementById('ticks');
  for (let i = 0; i < 12; i++) {
    const a = (i / 12) * Math.PI * 2 - Math.PI / 2;
    const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    l.setAttribute('x1', 90 + 75 * Math.cos(a)); l.setAttribute('y1', 90 + 75 * Math.sin(a));
    l.setAttribute('x2', 90 + 70 * Math.cos(a)); l.setAttribute('y2', 90 + 70 * Math.sin(a));
    l.setAttribute('stroke', 'rgba(0,210,255,0.2)'); l.setAttribute('stroke-width', '1');
    tg.appendChild(l);
  }
  addMsg('aura', 'AURA-X Œ© Ultimate online. Grand Emotional Continuity Equation initialised. Self-learning engine active. Voice/LLM/Image ready. Speak to me.', { emo: classifyEmotion(0), E0: 0 });
  
  // Session timer
  setInterval(() => {
    const s = Math.floor((Date.now() - STATE.sessionStart) / 1000);
    document.getElementById('sessionPill').textContent = 'SESSION: ' + Math.floor(s / 60) + ':' + (s % 60).toString().padStart(2, '0');
  }, 1000);
  
  // Particle system (simplified)
  const canvas = document.getElementById('particleCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    let w, h;
    function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();
    const particles = [];
    for (let i = 0; i < 50; i++) {
      particles.push({ x: Math.random() * w, y: Math.random() * h, vx: (Math.random()-0.5)*0.2, vy: (Math.random()-0.5)*0.2, r: Math.random()*2+1, a: Math.random()*0.3+0.1 });
    }
    function draw() {
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = 'rgba(0,210,255,0.1)';
      particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0 || p.x > w) p.vx *= -1;
        if (p.y < 0 || p.y > h) p.vy *= -1;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fillStyle = `rgba(0,210,255,${p.a})`;
        ctx.fill();
      });
      requestAnimationFrame(draw);
    }
    draw();
  }
}

window.addEventListener('DOMContentLoaded', init);

// Keyboard send
document.getElementById('userInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
</script>
</body>
</html>